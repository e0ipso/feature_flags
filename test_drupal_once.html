<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test: Drupal.once() Prevents Duplicate Context Provider Registrations</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #0678be;
      padding-bottom: 10px;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .step {
      margin: 15px 0;
      padding: 15px;
      border-left: 4px solid #0678be;
      background: #f9f9f9;
    }
    .pass {
      border-left-color: #28a745;
      background: #d4edda;
    }
    .fail {
      border-left-color: #dc3545;
      background: #f8d7da;
    }
    .step h3 {
      margin-top: 0;
      color: #333;
    }
    .result {
      font-family: monospace;
      background: #f4f4f4;
      padding: 10px;
      border-radius: 3px;
      margin-top: 10px;
    }
    button {
      background: #0678be;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #045a8d;
    }
    .summary {
      font-size: 18px;
      font-weight: bold;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
    }
    .summary.pass {
      background: #28a745;
      color: white;
    }
    .summary.fail {
      background: #dc3545;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Test: Drupal.once() Prevents Duplicate Context Provider Registrations</h1>

  <div class="test-section">
    <p><strong>Test Description:</strong> Verify that using Drupal.once() in a Drupal.behavior prevents context providers from being registered multiple times when attachBehaviors() is called repeatedly (e.g., during AJAX operations).</p>

    <button onclick="runTest()">Run Test</button>

    <div id="results"></div>
  </div>

  <script>
    let testResults = [];

    async function runTest() {
      testResults = [];
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<p>Running test...</p>';

      try {
        // Step 1: Register a context provider using the proper pattern with once()
        addStep('Step 1: Register Context Provider with Drupal.once()', 'running');

        let registrationAttempts = 0;
        let actualCalls = 0;

        // Create a test behavior that follows the recommended pattern
        window.testContextProvider = {
          attach: function(context, settings) {
            registrationAttempts++;

            // This is the RECOMMENDED pattern from documentation
            once('test-context-provider-' + Date.now(), 'html', context).forEach(() => {
              document.addEventListener('featureFlags:provideContext', (event) => {
                actualCalls++;
                event.detail.addContext('test_context_key', 'test_value_' + actualCalls);
              });
            });
          }
        };

        addStep('Step 1: Context provider registered', 'pass', {
          note: 'Using once() to prevent duplicate event listener registration'
        });

        // Step 2: Call attach() multiple times to simulate AJAX
        addStep('Step 2: Simulating multiple attachBehaviors() calls', 'running');

        // Simulate what happens during normal Drupal operation
        window.testContextProvider.attach(document.body);
        window.testContextProvider.attach(document.body);
        window.testContextProvider.attach(document.body);
        window.testContextProvider.attach(document.body);

        addStep('Step 2: Called attach() 4 times', 'pass', {
          attachCalls: registrationAttempts,
          note: 'Simulates AJAX updates, behaviors re-attaching, etc.'
        });

        // Step 3: Dispatch the context event and count how many listeners respond
        addStep('Step 3: Verify context provider registers only once', 'running');

        actualCalls = 0; // Reset counter

        // Manually dispatch the event to test
        const event = new CustomEvent('featureFlags:provideContext', {
          detail: {
            addContext: (key, value) => {
              // This gets called by each registered listener
            }
          }
        });

        document.dispatchEvent(event);

        const step3Pass = actualCalls === 1;
        addStep('Step 3: Context provider registration count', step3Pass ? 'pass' : 'fail', {
          expected: 1,
          actual: actualCalls,
          attachCallCount: registrationAttempts,
          result: step3Pass ? 'PASS: only 1 listener registered despite 4 attach() calls' : 'FAIL: multiple listeners registered'
        });

        // Step 4: Verify no duplicate context values
        addStep('Step 4: Verify no duplicates on subsequent events', 'running');

        actualCalls = 0;
        document.dispatchEvent(event);

        const step4Pass = actualCalls === 1;
        addStep('Step 4: Subsequent event dispatch', step4Pass ? 'pass' : 'fail', {
          expected: 1,
          actual: actualCalls,
          result: step4Pass ? 'PASS: consistent single listener' : 'FAIL: listener count changed'
        });

        // Overall result
        const allPassed = step3Pass && step4Pass;
        const summary = document.createElement('div');
        summary.className = 'summary ' + (allPassed ? 'pass' : 'fail');
        summary.innerHTML = allPassed ?
          '✓ TEST PASSED: Drupal.once() successfully prevents duplicate context provider registrations' :
          '✗ TEST FAILED: Issues detected with context provider registration';
        resultsDiv.appendChild(summary);

      } catch (error) {
        addStep('Error', 'fail', {
          error: error.message,
          stack: error.stack
        });
      }
    }

    function addStep(title, status, data = {}) {
      const resultsDiv = document.getElementById('results');
      const stepDiv = document.createElement('div');
      stepDiv.className = 'step ' + (status === 'pass' ? 'pass' : status === 'fail' ? 'fail' : '');

      let html = '<h3>' + title + '</h3>';

      if (Object.keys(data).length > 0) {
        html += '<div class="result">' + JSON.stringify(data, null, 2) + '</div>';
      }

      stepDiv.innerHTML = html;
      resultsDiv.appendChild(stepDiv);
    }

    // Auto-run test on page load
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(runTest, 500);
    });
  </script>
</body>
</html>
