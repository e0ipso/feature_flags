<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature Flags - BaseCondition Helpers Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      color: #0678be;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 3px solid #0678be;
    }

    .test-info {
      background: #e7f5ff;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
      border-left: 4px solid #0678be;
    }

    .test-info h2 {
      margin-bottom: 15px;
      color: #333;
    }

    .test-info ul {
      margin-left: 20px;
    }

    .test-info li {
      margin: 5px 0;
    }

    .test-section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .test-section h2 {
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
    }

    .test-section h3 {
      color: #666;
      font-size: 16px;
      font-style: italic;
      margin-bottom: 15px;
    }

    .result {
      margin: 15px 0;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .result.pass {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .result.fail {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .instruction {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
      color: #856404;
    }

    .instruction strong {
      display: block;
      margin-bottom: 5px;
    }

    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }

    .separator {
      margin: 40px 0;
      border-top: 3px solid #0678be;
      padding-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Feature Flags - BaseCondition Helper Methods Test</h1>

    <div class="test-info">
      <h2>Test #80 & #81: BaseCondition Helper Methods</h2>
      <p>This test verifies the helper methods in BaseCondition:</p>
      <ul>
        <li><strong>getContextValue():</strong> Retrieves values from context object</li>
        <li><strong>applyOperator():</strong> Applies AND/OR/NOT logic to match results</li>
      </ul>
    </div>

    <div class="instruction">
      <strong>Test Strategy:</strong>
      These tests create custom conditions that extend BaseCondition and verify the helper methods work correctly.
    </div>

    <!-- getContextValue Tests -->
    <h1 style="margin-top: 40px;">Test #80: getContextValue Helper</h1>

    <div class="test-section">
      <h2>Test 1: Returns value for valid context key</h2>
      <h3>Expected: getContextValue() returns the correct value from context</h3>
      <div id="test1-result" class="result">Running...</div>
    </div>

    <div class="test-section">
      <h2>Test 2: Returns undefined for missing key</h2>
      <h3>Expected: getContextValue() returns undefined when key doesn't exist</h3>
      <div id="test2-result" class="result">Running...</div>
    </div>

    <div class="test-section">
      <h2>Test 3: Works with various data types</h2>
      <h3>Expected: Correctly retrieves strings, numbers, booleans, objects, arrays</h3>
      <div id="test3-result" class="result">Running...</div>
    </div>

    <div class="test-section">
      <h2>Test 4: Works with nested context objects</h2>
      <h3>Expected: Can retrieve values at different levels (direct access only)</h3>
      <div id="test4-result" class="result">Running...</div>
    </div>

    <!-- applyOperator Tests -->
    <div class="separator">
      <h1>Test #81: applyOperator Helper</h1>
    </div>

    <div class="test-section">
      <h2>Test 5: OR operator returns match result as-is</h2>
      <h3>Expected: applyOperator(true) with OR returns true, applyOperator(false) returns false</h3>
      <div id="test5-result" class="result">Running...</div>
    </div>

    <div class="test-section">
      <h2>Test 6: NOT operator inverts the result</h2>
      <h3>Expected: applyOperator(true) with NOT returns false, applyOperator(false) returns true</h3>
      <div id="test6-result" class="result">Running...</div>
    </div>

    <div class="test-section">
      <h2>Test 7: AND operator behavior</h2>
      <h3>Expected: AND behaves same as OR for single value checks</h3>
      <div id="test7-result" class="result">Running...</div>
    </div>

    <div class="test-section">
      <h2>Test 8: Default operator is OR</h2>
      <h3>Expected: When no operator specified, defaults to OR behavior</h3>
      <div id="test8-result" class="result">Running...</div>
    </div>

    <div class="test-section">
      <h2>Test 9: Operator logic in real condition scenarios</h2>
      <h3>Expected: Operators work correctly in full evaluate() workflow</h3>
      <div id="test9-result" class="result">Running...</div>
    </div>
  </div>

  <!-- Load dependencies -->
  <script src="js/base/BaseCondition.js"></script>

  <script>
    // Create a test condition that extends BaseCondition
    class TestCondition extends BaseCondition {
      constructor(config, operator) {
        super(config, operator);
      }

      evaluate(context) {
        // Simple implementation that checks if user_id is in values array
        const userId = this.getContextValue(context, 'user_id');
        const matches = this.valueInArray(userId, this.config.values || []);
        return this.applyOperator(matches);
      }
    }

    // Helper function to display result
    function showResult(testId, passed, message) {
      const resultDiv = document.getElementById(testId);
      resultDiv.className = `result ${passed ? 'pass' : 'fail'}`;
      resultDiv.textContent = `Result: ${passed ? 'PASS' : 'FAIL'} - ${message}`;
    }

    // Run tests
    async function runTests() {
      try {
        // Test 1: Returns value for valid context key
        const condition1 = new TestCondition({}, 'OR');
        const context1 = { user_id: '12345', user_tier: 'premium' };
        const value1 = condition1.getContextValue(context1, 'user_id');

        showResult(
          'test1-result',
          value1 === '12345',
          value1 === '12345'
            ? `Correctly returned value: "${value1}"`
            : `Expected "12345", got: "${value1}"`
        );

        // Test 2: Returns undefined for missing key
        const value2 = condition1.getContextValue(context1, 'non_existent_key');

        showResult(
          'test2-result',
          value2 === undefined,
          value2 === undefined
            ? `Correctly returned undefined for missing key`
            : `Expected undefined, got: ${value2}`
        );

        // Test 3: Works with various data types
        const context3 = {
          string_val: 'test',
          number_val: 42,
          boolean_val: true,
          object_val: { nested: 'value' },
          array_val: [1, 2, 3],
          null_val: null
        };

        const stringVal = condition1.getContextValue(context3, 'string_val');
        const numberVal = condition1.getContextValue(context3, 'number_val');
        const boolVal = condition1.getContextValue(context3, 'boolean_val');
        const objVal = condition1.getContextValue(context3, 'object_val');
        const arrVal = condition1.getContextValue(context3, 'array_val');
        const nullVal = condition1.getContextValue(context3, 'null_val');

        const test3Pass = stringVal === 'test' &&
                         numberVal === 42 &&
                         boolVal === true &&
                         objVal.nested === 'value' &&
                         Array.isArray(arrVal) &&
                         nullVal === null;

        showResult(
          'test3-result',
          test3Pass,
          test3Pass
            ? `All data types retrieved correctly:\n  - string: "${stringVal}"\n  - number: ${numberVal}\n  - boolean: ${boolVal}\n  - object: ${JSON.stringify(objVal)}\n  - array: ${JSON.stringify(arrVal)}\n  - null: ${nullVal}`
            : `Some data types not retrieved correctly`
        );

        // Test 4: Works with nested context
        const context4 = {
          user: { id: '123', name: 'John' },
          settings: { theme: 'dark' }
        };

        const userObj = condition1.getContextValue(context4, 'user');
        const settingsObj = condition1.getContextValue(context4, 'settings');

        const test4Pass = userObj && userObj.id === '123' &&
                         settingsObj && settingsObj.theme === 'dark';

        showResult(
          'test4-result',
          test4Pass,
          test4Pass
            ? `Nested objects retrieved correctly:\n  - user: ${JSON.stringify(userObj)}\n  - settings: ${JSON.stringify(settingsObj)}`
            : `Failed to retrieve nested objects correctly`
        );

        // Test 5: OR operator returns match result as-is
        const conditionOR = new TestCondition({}, 'OR');
        const orTrue = conditionOR.applyOperator(true);
        const orFalse = conditionOR.applyOperator(false);

        showResult(
          'test5-result',
          orTrue === true && orFalse === false,
          orTrue === true && orFalse === false
            ? `OR operator works correctly:\n  - applyOperator(true) = ${orTrue}\n  - applyOperator(false) = ${orFalse}`
            : `OR operator failed: applyOperator(true) = ${orTrue}, applyOperator(false) = ${orFalse}`
        );

        // Test 6: NOT operator inverts the result
        const conditionNOT = new TestCondition({}, 'NOT');
        const notTrue = conditionNOT.applyOperator(true);
        const notFalse = conditionNOT.applyOperator(false);

        showResult(
          'test6-result',
          notTrue === false && notFalse === true,
          notTrue === false && notFalse === true
            ? `NOT operator works correctly:\n  - applyOperator(true) = ${notTrue}\n  - applyOperator(false) = ${notFalse}`
            : `NOT operator failed: applyOperator(true) = ${notTrue}, applyOperator(false) = ${notFalse}`
        );

        // Test 7: AND operator behavior
        const conditionAND = new TestCondition({}, 'AND');
        const andTrue = conditionAND.applyOperator(true);
        const andFalse = conditionAND.applyOperator(false);

        showResult(
          'test7-result',
          andTrue === true && andFalse === false,
          andTrue === true && andFalse === false
            ? `AND operator works correctly:\n  - applyOperator(true) = ${andTrue}\n  - applyOperator(false) = ${andFalse}`
            : `AND operator failed: applyOperator(true) = ${andTrue}, applyOperator(false) = ${andFalse}`
        );

        // Test 8: Default operator is OR
        const conditionDefault = new TestCondition({});  // No operator specified
        const defaultTrue = conditionDefault.applyOperator(true);
        const defaultFalse = conditionDefault.applyOperator(false);

        showResult(
          'test8-result',
          conditionDefault.operator === 'OR' && defaultTrue === true && defaultFalse === false,
          conditionDefault.operator === 'OR' && defaultTrue === true && defaultFalse === false
            ? `Default operator is OR:\n  - operator: "${conditionDefault.operator}"\n  - applyOperator(true) = ${defaultTrue}\n  - applyOperator(false) = ${defaultFalse}`
            : `Default operator failed: operator = "${conditionDefault.operator}"`
        );

        // Test 9: Operator logic in real condition scenarios
        const contextMatch = { user_id: '123' };
        const contextNoMatch = { user_id: '999' };

        const conditionORReal = new TestCondition({ values: ['123', '456'] }, 'OR');
        const conditionNOTReal = new TestCondition({ values: ['123', '456'] }, 'NOT');

        const orMatch = conditionORReal.evaluate(contextMatch);
        const orNoMatch = conditionORReal.evaluate(contextNoMatch);
        const notMatch = conditionNOTReal.evaluate(contextMatch);
        const notNoMatch = conditionNOTReal.evaluate(contextNoMatch);

        const test9Pass = orMatch === true &&     // 123 is in list, OR returns true
                         orNoMatch === false &&   // 999 not in list, OR returns false
                         notMatch === false &&    // 123 is in list, NOT inverts to false
                         notNoMatch === true;     // 999 not in list, NOT inverts to true

        showResult(
          'test9-result',
          test9Pass,
          test9Pass
            ? `Operators work correctly in real scenarios:\n  - OR with match: ${orMatch}\n  - OR with no match: ${orNoMatch}\n  - NOT with match: ${notMatch}\n  - NOT with no match: ${notNoMatch}`
            : `Operator logic failed in real scenarios`
        );

      } catch (error) {
        console.error('Test execution failed:', error);
        for (let i = 1; i <= 9; i++) {
          showResult(`test${i}-result`, false, `Error: ${error.message}`);
        }
      }
    }

    // Run tests when page loads
    window.addEventListener('load', runTests);
  </script>
</body>
</html>
