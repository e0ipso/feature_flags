<!DOCTYPE html>
<html>
<head>
    <title>Feature Flags JavaScript Test</title>
    <script>
        // Simulate drupalSettings from actual page output
        var drupalSettings = {
            "featureFlags": {
                "settings": {
                    "debug": true,
                    "persist": true
                },
                "flags": {
                    "test_feature_flag": {
                        "id": "test_feature_flag",
                        "label": "Test Feature Flag",
                        "variants": [
                            {
                                "uuid": "a148ebec-5d23-4995-bc84-9970e21a50b8",
                                "label": "Control",
                                "value": "{}"
                            },
                            {
                                "uuid": "aa1f402b-93fa-4ef7-a8dd-a5549b473c06",
                                "label": "Treatment",
                                "value": "{}"
                            }
                        ],
                        "algorithms": [
                            {
                                "uuid": "ed342c8c-e583-4dd9-b48d-361aadacb9e6",
                                "pluginId": "percentage_rollout",
                                "jsClass": "PercentageRollout",
                                "configuration": {
                                    "percentages": {
                                        "a148ebec-5d23-4995-bc84-9970e21a50b8": 50,
                                        "aa1f402b-93fa-4ef7-a8dd-a5549b473c06": 50
                                    }
                                },
                                "conditions": []
                            }
                        ]
                    }
                },
                "libraries": {
                    "algorithms": {
                        "percentage_rollout": "PercentageRollout"
                    },
                    "conditions": []
                }
            }
        };

        // Simulate Drupal namespace
        var Drupal = Drupal || {};
        Drupal.featureFlags = Drupal.featureFlags || {};
    </script>
</head>
<body>
    <h1>Feature Flags JavaScript Test</h1>
    <div id="results"></div>

    <script>
        // Load JavaScript files in order
        var scripts = [
            '/modules/contrib/feature_flags/js/base/FeatureFlagConfig.js',
            '/modules/contrib/feature_flags/js/base/FeatureFlagResult.js',
            '/modules/contrib/feature_flags/js/base/BaseAlgorithm.js',
            '/modules/contrib/feature_flags/js/base/BaseCondition.js',
            '/modules/contrib/feature_flags/js/base/FeatureFlagManager.js',
            '/modules/contrib/feature_flags/js/algorithm/PercentageRollout.js'
        ];

        var loadedScripts = 0;
        var results = document.getElementById('results');

        function loadNextScript() {
            if (loadedScripts < scripts.length) {
                var script = document.createElement('script');
                script.src = scripts[loadedScripts];
                script.onload = function() {
                    results.innerHTML += '<p>✅ Loaded: ' + scripts[loadedScripts] + '</p>';
                    loadedScripts++;
                    loadNextScript();
                };
                script.onerror = function() {
                    results.innerHTML += '<p>❌ Failed to load: ' + scripts[loadedScripts] + '</p>';
                    loadedScripts++;
                    loadNextScript();
                };
                document.head.appendChild(script);
            } else {
                runTests();
            }
        }

        function runTests() {
            results.innerHTML += '<h2>Running Tests</h2>';

            try {
                // Test 1: Manager exists
                if (typeof FeatureFlagManager !== 'undefined') {
                    results.innerHTML += '<p>✅ FeatureFlagManager class loaded</p>';
                } else {
                    results.innerHTML += '<p>❌ FeatureFlagManager class not found</p>';
                    return;
                }

                // Test 2: Initialize manager
                var manager = new FeatureFlagManager(drupalSettings.featureFlags.settings);
                results.innerHTML += '<p>✅ FeatureFlagManager instantiated</p>';

                // Test 3: Load flags
                manager.loadFlags(drupalSettings.featureFlags.flags, drupalSettings.featureFlags.libraries);
                results.innerHTML += '<p>✅ Flags loaded into manager</p>';

                // Test 4: Resolve a flag
                var result = manager.resolve('test_feature_flag', {userId: '123'});
                if (result) {
                    results.innerHTML += '<p>✅ Flag resolved: ' + result.variant.label + ' (UUID: ' + result.variant.uuid + ')</p>';
                    results.innerHTML += '<p>  Algorithm: ' + result.algorithmId + '</p>';
                    results.innerHTML += '<p>  Flag ID: ' + result.flagId + '</p>';
                } else {
                    results.innerHTML += '<p>❌ Flag resolution failed</p>';
                }

                // Test 5: Test distribution (run multiple times to verify it's working)
                var distribution = {Control: 0, Treatment: 0};
                for (var i = 0; i < 100; i++) {
                    var testResult = manager.resolve('test_feature_flag', {userId: 'user' + i});
                    if (testResult) {
                        distribution[testResult.variant.label]++;
                    }
                }
                results.innerHTML += '<p>✅ Distribution test (100 users):</p>';
                results.innerHTML += '<p>  Control: ' + distribution.Control + '%</p>';
                results.innerHTML += '<p>  Treatment: ' + distribution.Treatment + '%</p>';

                results.innerHTML += '<h2>✅ All Tests Passed!</h2>';

            } catch (e) {
                results.innerHTML += '<p>❌ Error: ' + e.message + '</p>';
                results.innerHTML += '<pre>' + e.stack + '</pre>';
            }
        }

        // Start loading scripts
        loadNextScript();
    </script>
</body>
</html>
