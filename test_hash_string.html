<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature Flags - hashString Helper Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      color: #0678be;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 3px solid #0678be;
    }

    .test-info {
      background: #e7f5ff;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
      border-left: 4px solid #0678be;
    }

    .test-info h2 {
      margin-bottom: 15px;
      color: #333;
    }

    .test-info ul {
      margin-left: 20px;
    }

    .test-info li {
      margin: 5px 0;
    }

    .test-section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .test-section h2 {
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
    }

    .test-section h3 {
      color: #666;
      font-size: 16px;
      font-style: italic;
      margin-bottom: 15px;
    }

    .result {
      margin: 15px 0;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .result.pass {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .result.fail {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .instruction {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
      color: #856404;
    }

    .instruction strong {
      display: block;
      margin-bottom: 5px;
    }

    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }

    .data-table {
      width: 100%;
      margin: 15px 0;
      border-collapse: collapse;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    .data-table th,
    .data-table td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
    }

    .data-table th {
      background: #f0f0f0;
      font-weight: bold;
    }

    .data-table tr:nth-child(even) {
      background: #f9f9f9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Feature Flags - hashString Helper Test</h1>

    <div class="test-info">
      <h2>Test #78: BaseAlgorithm provides hashString helper for deterministic bucketing</h2>
      <p>This test verifies that the <code>hashString()</code> method in BaseAlgorithm provides deterministic hashing for consistent user bucketing.</p>
      <ul>
        <li><strong>Purpose:</strong> Ensure users get the same variant consistently when persistence is enabled</li>
        <li><strong>Method:</strong> hashString(str) returns a number 0-99</li>
        <li><strong>Requirement:</strong> Same input always produces same hash</li>
        <li><strong>Requirement:</strong> Different inputs produce different hashes</li>
      </ul>
    </div>

    <div class="instruction">
      <strong>Test Strategy:</strong>
      This test creates a custom algorithm that extends BaseAlgorithm and uses the hashString helper method to verify deterministic behavior.
    </div>

    <!-- Test 1 -->
    <div class="test-section">
      <h2>Test 1: Same input produces same hash</h2>
      <h3>Expected: Calling hashString() with identical input multiple times returns same value</h3>
      <div id="test1-result" class="result">Running...</div>
      <table id="test1-data" class="data-table" style="display:none;">
        <thead>
          <tr>
            <th>Attempt</th>
            <th>Input</th>
            <th>Hash Result</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Test 2 -->
    <div class="test-section">
      <h2>Test 2: Different inputs produce different hashes</h2>
      <h3>Expected: Different input strings produce different hash values</h3>
      <div id="test2-result" class="result">Running...</div>
      <table id="test2-data" class="data-table" style="display:none;">
        <thead>
          <tr>
            <th>Input</th>
            <th>Hash Result</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Test 3 -->
    <div class="test-section">
      <h2>Test 3: Hash values are in range 0-99</h2>
      <h3>Expected: All hash values are between 0 and 99 inclusive</h3>
      <div id="test3-result" class="result">Running...</div>
    </div>

    <!-- Test 4 -->
    <div class="test-section">
      <h2>Test 4: Hash is deterministic across multiple instances</h2>
      <h3>Expected: Creating new algorithm instances produces same hash for same input</h3>
      <div id="test4-result" class="result">Running...</div>
    </div>

    <!-- Test 5 -->
    <div class="test-section">
      <h2>Test 5: Hash works with various string types</h2>
      <h3>Expected: Hash works with UUIDs, numbers, and complex strings</h3>
      <div id="test5-result" class="result">Running...</div>
      <table id="test5-data" class="data-table" style="display:none;">
        <thead>
          <tr>
            <th>String Type</th>
            <th>Input</th>
            <th>Hash Result</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Load dependencies -->
  <script src="js/base/BaseAlgorithm.js"></script>

  <script>
    // Create a test algorithm that extends BaseAlgorithm
    class TestHashAlgorithm extends BaseAlgorithm {
      constructor(variants, config) {
        super(variants, config);
      }

      async decide(context) {
        // Simple implementation - not used for these tests
        return this.variants[0];
      }
    }

    // Helper function to display result
    function showResult(testId, passed, message) {
      const resultDiv = document.getElementById(testId);
      resultDiv.className = `result ${passed ? 'pass' : 'fail'}`;
      resultDiv.textContent = `Result: ${passed ? 'PASS' : 'FAIL'} - ${message}`;
    }

    // Helper to add table row
    function addTableRow(tableId, cells) {
      const table = document.getElementById(tableId);
      const tbody = table.querySelector('tbody');
      const row = tbody.insertRow();
      cells.forEach(cellText => {
        const cell = row.insertCell();
        cell.textContent = cellText;
      });
      table.style.display = 'table';
    }

    // Run tests
    async function runTests() {
      try {
        // Setup test variants
        const variants = [
          { uuid: 'variant-a', label: 'Variant A', weight: 0 },
          { uuid: 'variant-b', label: 'Variant B', weight: 1 }
        ];

        const config = { percentages: { 'variant-a': 50, 'variant-b': 50 } };

        // Test 1: Same input produces same hash
        const algo1 = new TestHashAlgorithm(variants, config);
        const testInput = 'test-user-12345';
        const hashes = [];

        for (let i = 1; i <= 10; i++) {
          const hash = algo1.hashString(testInput);
          hashes.push(hash);
          addTableRow('test1-data', [
            `#${i}`,
            testInput,
            hash.toString()
          ]);
        }

        const allSame = hashes.every(h => h === hashes[0]);
        showResult(
          'test1-result',
          allSame,
          allSame
            ? `All 10 calls returned same hash: ${hashes[0]}`
            : `Hashes varied: ${[...new Set(hashes)].join(', ')}`
        );

        // Test 2: Different inputs produce different hashes
        const inputs = [
          'user-123',
          'user-456',
          'user-789',
          'test-flag-abc',
          'test-flag-xyz',
          'different-string'
        ];

        const inputHashes = [];
        inputs.forEach(input => {
          const hash = algo1.hashString(input);
          inputHashes.push(hash);
          addTableRow('test2-data', [input, hash.toString()]);
        });

        const uniqueHashes = new Set(inputHashes);
        const mostlyDifferent = uniqueHashes.size >= inputs.length * 0.8; // Allow some collision
        showResult(
          'test2-result',
          mostlyDifferent,
          mostlyDifferent
            ? `Generated ${uniqueHashes.size} unique hashes from ${inputs.length} inputs`
            : `Only ${uniqueHashes.size} unique hashes from ${inputs.length} inputs (possible collision issue)`
        );

        // Test 3: Hash values are in range 0-99
        const rangeTestInputs = [
          'a', 'z', 'test', 'user-1', 'user-999999',
          'very-long-string-with-many-characters-to-test-edge-cases',
          '12345', 'UUID-123e4567-e89b-12d3-a456-426614174000',
          'special!@#$%^&*()', ''
        ];

        let allInRange = true;
        let minHash = 100;
        let maxHash = -1;

        rangeTestInputs.forEach(input => {
          const hash = algo1.hashString(input);
          if (hash < 0 || hash > 99) allInRange = false;
          minHash = Math.min(minHash, hash);
          maxHash = Math.max(maxHash, hash);
        });

        showResult(
          'test3-result',
          allInRange,
          allInRange
            ? `All hashes in range 0-99 (min: ${minHash}, max: ${maxHash})`
            : `Some hashes out of range 0-99`
        );

        // Test 4: Deterministic across instances
        const algo2 = new TestHashAlgorithm(variants, config);
        const algo3 = new TestHashAlgorithm(variants, config);

        const testInputs = ['user-abc', 'flag-123', 'test-xyz'];
        let allInstancesMatch = true;

        testInputs.forEach(input => {
          const hash1 = algo1.hashString(input);
          const hash2 = algo2.hashString(input);
          const hash3 = algo3.hashString(input);

          if (hash1 !== hash2 || hash2 !== hash3) {
            allInstancesMatch = false;
          }
        });

        showResult(
          'test4-result',
          allInstancesMatch,
          allInstancesMatch
            ? `All algorithm instances produced identical hashes for same inputs`
            : `Different instances produced different hashes`
        );

        // Test 5: Works with various string types
        const stringTypes = [
          ['UUID', 'f47ac10b-58cc-4372-a567-0e02b2c3d479'],
          ['Number as string', '1234567890'],
          ['Flag ID format', 'test_feature_flag_01'],
          ['User ID format', 'user-12345'],
          ['Complex string', 'flag:test_flag+user:12345@context:premium'],
          ['Empty string', ''],
          ['Single char', 'x'],
          ['Unicode', 'Test-用户-123']
        ];

        let allTypesWork = true;
        stringTypes.forEach(([type, input]) => {
          try {
            const hash = algo1.hashString(input);
            const inRange = hash >= 0 && hash <= 99;
            if (!inRange) allTypesWork = false;
            addTableRow('test5-data', [type, input, hash.toString()]);
          } catch (e) {
            allTypesWork = false;
            addTableRow('test5-data', [type, input, `ERROR: ${e.message}`]);
          }
        });

        showResult(
          'test5-result',
          allTypesWork,
          allTypesWork
            ? `All string types hashed successfully`
            : `Some string types failed to hash`
        );

      } catch (error) {
        console.error('Test execution failed:', error);
        showResult('test1-result', false, `Error: ${error.message}`);
        showResult('test2-result', false, `Error: ${error.message}`);
        showResult('test3-result', false, `Error: ${error.message}`);
        showResult('test4-result', false, `Error: ${error.message}`);
        showResult('test5-result', false, `Error: ${error.message}`);
      }
    }

    // Run tests when page loads
    window.addEventListener('load', runTests);
  </script>
</body>
</html>
