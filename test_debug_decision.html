<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature Flags - Debug Decision Logging Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      color: #0678be;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 3px solid #0678be;
    }

    .test-info {
      background: #e7f5ff;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
      border-left: 4px solid #0678be;
    }

    .test-info h2 {
      margin-bottom: 15px;
      color: #333;
    }

    .test-info ul {
      margin-left: 20px;
    }

    .test-info li {
      margin: 5px 0;
    }

    .test-section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .test-section h2 {
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
    }

    .test-section h3 {
      color: #666;
      font-size: 16px;
      font-style: italic;
      margin-bottom: 15px;
    }

    .result {
      margin: 15px 0;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .result.pass {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .result.fail {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .instruction {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
      color: #856404;
    }

    .instruction strong {
      display: block;
      margin-bottom: 5px;
    }

    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }

    .console-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin: 15px 0;
      max-height: 300px;
      overflow-y: auto;
    }

    .console-output .debug {
      color: #4ec9b0;
    }

    .console-output .error {
      color: #f48771;
    }

    .console-output .timestamp {
      color: #808080;
    }

    .highlight {
      background: #ffeb3b;
      color: #000;
      padding: 2px 4px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Feature Flags - Debug Decision Logging Test</h1>

    <div class="test-info">
      <h2>Test #77: Debug logs show final decision with variant label and UUID</h2>
      <p>This test verifies that when debug mode is enabled, the final decision log includes both the variant label and UUID in the format: <code>Decision: variant {label} ({uuid})</code></p>
      <ul>
        <li><strong>Test requirement:</strong> Verify log format shows label and UUID</li>
        <li><strong>Expected format:</strong> "Decision: variant Variant A (variant-a-uuid-123)"</li>
        <li><strong>Debug mode:</strong> Enabled</li>
      </ul>
    </div>

    <div class="instruction">
      <strong>IMPORTANT: Open your browser's Developer Console (F12) to see debug logs!</strong>
      The console output will also be captured and displayed below for verification.
    </div>

    <!-- Test 1 -->
    <div class="test-section">
      <h2>Test 1: Decision log contains variant label</h2>
      <h3>Expected: Log should contain "Decision: variant {label}"</h3>
      <div id="test1-result" class="result">Running...</div>
    </div>

    <!-- Test 2 -->
    <div class="test-section">
      <h2>Test 2: Decision log contains variant UUID in parentheses</h2>
      <h3>Expected: Log should contain "({uuid})" after the label</h3>
      <div id="test2-result" class="result">Running...</div>
    </div>

    <!-- Test 3 -->
    <div class="test-section">
      <h2>Test 3: Decision log format matches specification</h2>
      <h3>Expected: Full format is "Decision: variant {label} ({uuid})"</h3>
      <div id="test3-result" class="result">Running...</div>
    </div>

    <!-- Test 4 -->
    <div class="test-section">
      <h2>Test 4: Decision log with multiple resolutions</h2>
      <h3>Expected: Each resolution shows correct variant label and UUID</h3>
      <div id="test4-result" class="result">Running...</div>
    </div>

    <!-- Test 5 -->
    <div class="test-section">
      <h2>Test 5: Decision log with different variants</h2>
      <h3>Expected: Decision log correctly identifies different variants</h3>
      <div id="test5-result" class="result">Running...</div>
    </div>

    <div class="instruction">
      <strong>Console Output Capture:</strong>
      The captured logs below show all console.debug() calls. Look for the highlighted "Decision:" log entries.
    </div>

    <div id="console-capture" class="console-output">
      Waiting for test execution...
    </div>
  </div>

  <!-- Load dependencies -->
  <script src="js/base/FeatureFlagConfig.js"></script>
  <script src="js/base/FeatureFlagResult.js"></script>
  <script src="js/base/BaseAlgorithm.js"></script>
  <script src="js/base/BaseCondition.js"></script>
  <script src="js/algorithm/PercentageRollout.js"></script>
  <script src="js/condition/UserId.js"></script>
  <script src="js/condition/UserTier.js"></script>
  <script src="js/base/FeatureFlagManager.js"></script>

  <script>
    // Capture console.debug calls
    const debugLogs = [];
    const originalDebug = console.debug;
    console.debug = function(...args) {
      debugLogs.push(args);
      originalDebug.apply(console, args);
    };

    // Mock drupalSettings
    window.drupalSettings = {
      featureFlags: {
        settings: {
          debug_mode: true,  // Debug mode ENABLED
          persist: false
        },
        flags: {
          test_decision: {
            id: 'test_decision',
            label: 'Decision Test Flag',
            description: 'Feature flag for testing decision logging',
            status: true,
            variants: [
              {
                uuid: 'variant-a-uuid-123',
                label: 'Variant A',
                weight: 0
              },
              {
                uuid: 'variant-b-uuid-456',
                label: 'Variant B',
                weight: 1
              }
            ],
            algorithms: [
              {
                uuid: 'algo-uuid-789',
                pluginId: 'percentage_rollout',
                jsClass: 'PercentageRollout',
                weight: 0,
                configuration: {
                  percentages: {
                    'variant-a-uuid-123': 100,
                    'variant-b-uuid-456': 0
                  }
                },
                conditions: []
              }
            ]
          },
          test_decision_b: {
            id: 'test_decision_b',
            label: 'Decision Test Flag B',
            description: 'Second flag for testing',
            status: true,
            variants: [
              {
                uuid: 'variant-x-uuid-999',
                label: 'Variant X',
                weight: 0
              },
              {
                uuid: 'variant-y-uuid-888',
                label: 'Variant Y',
                weight: 1
              }
            ],
            algorithms: [
              {
                uuid: 'algo-uuid-888',
                pluginId: 'percentage_rollout',
                jsClass: 'PercentageRollout',
                weight: 0,
                configuration: {
                  percentages: {
                    'variant-x-uuid-999': 0,
                    'variant-y-uuid-888': 100
                  }
                },
                conditions: []
              }
            ]
          }
        },
        libraries: {}
      }
    };

    // Helper function to display result
    function showResult(testId, passed, message) {
      const resultDiv = document.getElementById(testId);
      resultDiv.className = `result ${passed ? 'pass' : 'fail'}`;
      resultDiv.textContent = `Result: ${passed ? 'PASS' : 'FAIL'} - ${message}`;
    }

    // Helper function to update console capture display
    function updateConsoleCapture() {
      const captureDiv = document.getElementById('console-capture');
      let output = '';

      debugLogs.forEach((args) => {
        const timestamp = new Date().toISOString().substr(11, 12);
        output += `<span class="timestamp">[${timestamp}]</span> <span class="debug">`;

        const logText = args.join(' ');

        // Highlight decision logs
        if (logText.includes('Decision:')) {
          output += `<span class="highlight">${logText}</span>`;
        } else {
          args.forEach((arg, i) => {
            if (i > 0) output += ' ';

            if (typeof arg === 'object') {
              output += JSON.stringify(arg, null, 2);
            } else {
              output += String(arg);
            }
          });
        }

        output += '</span>\n';
      });

      captureDiv.innerHTML = output || 'No debug logs captured yet...';
    }

    // Helper to find decision logs
    function findDecisionLogs() {
      return debugLogs.filter(args => {
        const logText = args.join(' ');
        return logText.includes('Decision:');
      });
    }

    // Run tests
    async function runTests() {
      try {
        // Clear previous logs
        debugLogs.length = 0;
        localStorage.clear();

        // Test 1-3: Resolve first flag and check format
        const manager = new FeatureFlagManager({ user_id: 'test-user-123' });
        const result1 = await manager.resolve('test_decision');

        const decisionLogs = findDecisionLogs();
        const logText = decisionLogs.map(args => args.join(' ')).join('\n');

        // Test 1: Check for variant label
        const hasLabel = logText.includes('Variant A');
        showResult(
          'test1-result',
          hasLabel,
          hasLabel
            ? `Found variant label "Variant A" in decision log`
            : 'Variant label not found in decision log'
        );

        // Test 2: Check for UUID in parentheses
        const hasUuid = logText.includes('(variant-a-uuid-123)');
        showResult(
          'test2-result',
          hasUuid,
          hasUuid
            ? `Found UUID "(variant-a-uuid-123)" in decision log`
            : 'UUID in parentheses not found in decision log'
        );

        // Test 3: Check full format
        const expectedFormat = 'Decision: variant Variant A (variant-a-uuid-123)';
        const hasCorrectFormat = logText.includes(expectedFormat);
        showResult(
          'test3-result',
          hasCorrectFormat,
          hasCorrectFormat
            ? `Decision log matches expected format: "${expectedFormat}"`
            : `Expected format: "${expectedFormat}", Got: "${logText}"`
        );

        // Test 4: Multiple resolutions
        debugLogs.length = 0;
        await manager.resolve('test_decision');
        const secondResolve = await manager.resolve('test_decision');

        const multiLogs = findDecisionLogs();
        const hasMultipleLogs = multiLogs.length === 2;
        const bothCorrect = multiLogs.every(args => {
          const log = args.join(' ');
          return log.includes('Variant A') && log.includes('(variant-a-uuid-123)');
        });

        showResult(
          'test4-result',
          hasMultipleLogs && bothCorrect,
          hasMultipleLogs && bothCorrect
            ? `Both resolutions logged correctly with label and UUID`
            : hasMultipleLogs
            ? `Found ${multiLogs.length} logs but format incorrect`
            : `Expected 2 logs, found ${multiLogs.length}`
        );

        // Test 5: Different variants
        debugLogs.length = 0;
        const result2 = await manager.resolve('test_decision_b');

        const variantBLogs = findDecisionLogs();
        const variantBText = variantBLogs.map(args => args.join(' ')).join('\n');
        const hasVariantY = variantBText.includes('Variant Y');
        const hasVariantYUuid = variantBText.includes('(variant-y-uuid-888)');

        showResult(
          'test5-result',
          hasVariantY && hasVariantYUuid,
          hasVariantY && hasVariantYUuid
            ? `Different variant logged correctly: "Variant Y (variant-y-uuid-888)"`
            : `Expected "Variant Y (variant-y-uuid-888)", Got: "${variantBText}"`
        );

        // Update console capture with all logs
        updateConsoleCapture();

      } catch (error) {
        console.error('Test execution failed:', error);
        showResult('test1-result', false, `Error: ${error.message}`);
        showResult('test2-result', false, `Error: ${error.message}`);
        showResult('test3-result', false, `Error: ${error.message}`);
        showResult('test4-result', false, `Error: ${error.message}`);
        showResult('test5-result', false, `Error: ${error.message}`);

        // Show error in console capture
        const captureDiv = document.getElementById('console-capture');
        captureDiv.innerHTML = `<span class="error">Error: ${error.message}\n${error.stack}</span>`;
      }
    }

    // Run tests when page loads
    window.addEventListener('load', runTests);
  </script>
</body>
</html>
