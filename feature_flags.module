<?php

/**
 * @file
 * Primary module file for Feature Flags module.
 *
 * Provides client-side feature flag management with decision algorithms
 * and conditions for personalized user experiences.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function feature_flags_help(string $route_name, RouteMatchInterface $route_match): string {
  switch ($route_name) {
    case 'help.page.feature_flags':
      $output = '<h2>' . t('About') . '</h2>';
      $output .= '<p>' . t('The Feature Flags module enables site administrators to create feature flags with multiple variants, configure decision algorithms with conditions, and resolve variants client-side via JavaScript. This allows for personalized experiences even behind caching layers.') . '</p>';
      $output .= '<h2>' . t('Uses') . '</h2>';
      $output .= '<dl>';
      $output .= '<dt>' . t('Managing feature flags') . '</dt>';
      $output .= '<dd>' . t('Create and manage feature flags at <a href=":url">Configuration → Services → Feature Flags</a>.', [':url' => '/admin/config/services/feature-flags/list']) . '</dd>';
      $output .= '<dt>' . t('Configuring variants') . '</dt>';
      $output .= '<dd>' . t('Each feature flag can have multiple variants with JSON-encoded values. Use the CodeMirror JSON editor for syntax validation.') . '</dd>';
      $output .= '<dt>' . t('Setting up algorithms') . '</dt>';
      $output .= '<dd>' . t('Add decision algorithms (like Percentage Rollout) to determine which variant users receive. Apply conditions to algorithms for targeted rollouts.') . '</dd>';
      $output .= '<dt>' . t('Client-side resolution') . '</dt>';
      $output .= '<dd>' . t('Feature flags are resolved in JavaScript using <code>Drupal.featureFlags.resolve()</code>. This works seamlessly with page caching.') . '</dd>';
      $output .= '</dl>';
      return $output;

    case 'entity.feature_flag.collection':
      return '<p>' . t('Feature flags allow you to control feature rollouts and run A/B tests without deploying code. Create flags with multiple variants and configure algorithms to determine which variant each user receives.') . '</p>';
  }

  return '';
}

/**
 * Implements hook_page_attachments().
 *
 * Attaches enabled feature flags and their settings to every page.
 */
function feature_flags_page_attachments(array &$attachments): void {
  \Drupal::service('feature_flags.attachment_builder')->buildAttachments($attachments);
}

/**
 * Implements hook_library_info_alter().
 */
function feature_flags_library_info_alter(&$libraries, $extension) {
  \Drupal::service('feature_flags.attachment_builder')->alterLibrariesInfo($libraries, $extension);
}
