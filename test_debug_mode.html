<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature Flags - Debug Mode Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      color: #0678be;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 3px solid #0678be;
    }

    .test-info {
      background: #e7f5ff;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
      border-left: 4px solid #0678be;
    }

    .test-info h2 {
      margin-bottom: 15px;
      color: #333;
    }

    .test-info ul {
      margin-left: 20px;
    }

    .test-info li {
      margin: 5px 0;
    }

    .test-section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .test-section h2 {
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
    }

    .test-section h3 {
      color: #666;
      font-size: 16px;
      font-style: italic;
      margin-bottom: 15px;
    }

    .result {
      margin: 15px 0;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .result.pass {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .result.fail {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .instruction {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
      color: #856404;
    }

    .instruction strong {
      display: block;
      margin-bottom: 5px;
    }

    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }

    .console-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin: 15px 0;
      max-height: 300px;
      overflow-y: auto;
    }

    .console-output .debug {
      color: #4ec9b0;
    }

    .console-output .error {
      color: #f48771;
    }

    .console-output .timestamp {
      color: #808080;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Feature Flags - Debug Mode Test</h1>

    <div class="test-info">
      <h2>Test #72: Debug mode logs resolution steps to console when enabled</h2>
      <p>This test verifies that when debug mode is enabled in settings, the FeatureFlagManager logs detailed resolution information to the browser console.</p>
      <ul>
        <li><strong>Feature flag:</strong> "test_debug" with 2 variants</li>
        <li><strong>Algorithm:</strong> Percentage rollout (50/50 split)</li>
        <li><strong>Debug mode:</strong> Enabled</li>
        <li><strong>Expected logs:</strong> "Resolving flag:", "Context:", "Evaluating algorithm:", "Decision:"</li>
      </ul>
    </div>

    <div class="instruction">
      <strong>IMPORTANT: Open your browser's Developer Console (F12) to see debug logs!</strong>
      This test verifies that console.debug() messages are being written. The results below indicate whether the logs were generated, but you should verify them visually in the console.
    </div>

    <!-- Test 1 -->
    <div class="test-section">
      <h2>Test 1: Debug mode logs resolution steps</h2>
      <h3>Expected: Console should contain debug logs for "Resolving flag:", "Context:", "Evaluating algorithm:", "Decision:"</h3>
      <div id="test1-result" class="result">Running...</div>
    </div>

    <!-- Test 2 -->
    <div class="test-section">
      <h2>Test 2: Debug logs include flag ID</h2>
      <h3>Expected: Debug log should contain the flag ID "test_debug"</h3>
      <div id="test2-result" class="result">Running...</div>
    </div>

    <!-- Test 3 -->
    <div class="test-section">
      <h2>Test 3: Debug logs show context object</h2>
      <h3>Expected: Context log should show the context object with user_id</h3>
      <div id="test3-result" class="result">Running...</div>
    </div>

    <!-- Test 4 -->
    <div class="test-section">
      <h2>Test 4: Debug logs show algorithm evaluation</h2>
      <h3>Expected: Log should show "Evaluating algorithm: percentage_rollout"</h3>
      <div id="test4-result" class="result">Running...</div>
    </div>

    <!-- Test 5 -->
    <div class="test-section">
      <h2>Test 5: Debug logs show final decision</h2>
      <h3>Expected: Log should show "Decision: variant" with variant label</h3>
      <div id="test5-result" class="result">Running...</div>
    </div>

    <div class="instruction">
      <strong>Console Output Capture:</strong>
      The test will capture console.debug() calls and display them below. Check that all expected log messages appear.
    </div>

    <div id="console-capture" class="console-output">
      Waiting for test execution...
    </div>
  </div>

  <!-- Load dependencies -->
  <script src="js/base/FeatureFlagConfig.js"></script>
  <script src="js/base/FeatureFlagResult.js"></script>
  <script src="js/base/BaseAlgorithm.js"></script>
  <script src="js/base/BaseCondition.js"></script>
  <script src="js/algorithm/PercentageRollout.js"></script>
  <script src="js/condition/UserId.js"></script>
  <script src="js/base/FeatureFlagManager.js"></script>

  <script>
    // Capture console.debug calls
    const debugLogs = [];
    const originalDebug = console.debug;
    console.debug = function(...args) {
      debugLogs.push(args);
      originalDebug.apply(console, args);
    };

    // Mock drupalSettings
    window.drupalSettings = {
      featureFlags: {
        settings: {
          debug_mode: true,  // Debug mode ENABLED
          persist: false
        },
        flags: {
          test_debug: {
            id: 'test_debug',
            label: 'Debug Test Flag',
            description: 'Feature flag for testing debug mode',
            status: true,
            variants: [
              {
                uuid: 'variant-a-uuid-123',
                label: 'Variant A',
                weight: 0
              },
              {
                uuid: 'variant-b-uuid-456',
                label: 'Variant B',
                weight: 1
              }
            ],
            algorithms: [
              {
                uuid: 'algo-uuid-789',
                pluginId: 'percentage_rollout',
                jsClass: 'PercentageRollout',
                weight: 0,
                configuration: {
                  percentages: {
                    'variant-a-uuid-123': 50,
                    'variant-b-uuid-456': 50
                  }
                },
                conditions: []
              }
            ]
          }
        },
        libraries: {}
      }
    };

    // Helper function to display result
    function showResult(testId, passed, message) {
      const resultDiv = document.getElementById(testId);
      resultDiv.className = `result ${passed ? 'pass' : 'fail'}`;
      resultDiv.textContent = `Result: ${passed ? 'PASS' : 'FAIL'} - ${message}`;
    }

    // Helper function to update console capture display
    function updateConsoleCapture() {
      const captureDiv = document.getElementById('console-capture');
      let output = '';

      debugLogs.forEach((args, index) => {
        const timestamp = new Date().toISOString().substr(11, 12);
        output += `<span class="timestamp">[${timestamp}]</span> <span class="debug">`;

        args.forEach((arg, i) => {
          if (i > 0) output += ' ';

          if (typeof arg === 'object') {
            output += JSON.stringify(arg, null, 2);
          } else {
            output += String(arg);
          }
        });

        output += '</span>\n';
      });

      captureDiv.innerHTML = output || 'No debug logs captured yet...';
    }

    // Run tests
    async function runTests() {
      try {
        // Clear previous logs
        debugLogs.length = 0;
        localStorage.clear();

        // Create manager and resolve flag
        const manager = new FeatureFlagManager({ user_id: 'test-user-123' });
        const result = await manager.resolve('test_debug');

        // Update console capture
        updateConsoleCapture();

        // Test 1: Check that debug logs were generated
        const hasLogs = debugLogs.length > 0;
        const logText = debugLogs.map(args => args.join(' ')).join('\n');

        showResult(
          'test1-result',
          hasLogs,
          hasLogs
            ? `Generated ${debugLogs.length} debug log entries`
            : 'No debug logs were generated'
        );

        // Test 2: Check for "Resolving flag: test_debug"
        const hasResolvingLog = logText.includes('Resolving flag:') && logText.includes('test_debug');
        showResult(
          'test2-result',
          hasResolvingLog,
          hasResolvingLog
            ? 'Found "Resolving flag: test_debug" in logs'
            : 'Missing "Resolving flag:" log entry'
        );

        // Test 3: Check for "Context:" log
        const hasContextLog = logText.includes('Context:');
        const contextLogEntry = debugLogs.find(args => args[1] === 'Context:');
        const hasUserId = contextLogEntry && JSON.stringify(contextLogEntry).includes('user_id');

        showResult(
          'test3-result',
          hasContextLog && hasUserId,
          hasContextLog && hasUserId
            ? 'Found "Context:" log with user_id'
            : hasContextLog
            ? 'Found "Context:" but missing user_id'
            : 'Missing "Context:" log entry'
        );

        // Test 4: Check for "Evaluating algorithm:" log
        const hasAlgorithmLog = logText.includes('Evaluating algorithm:') && logText.includes('percentage_rollout');
        showResult(
          'test4-result',
          hasAlgorithmLog,
          hasAlgorithmLog
            ? 'Found "Evaluating algorithm: percentage_rollout" in logs'
            : 'Missing "Evaluating algorithm:" log entry'
        );

        // Test 5: Check for "Decision:" log
        const hasDecisionLog = logText.includes('Decision:') &&
                              (logText.includes('Variant A') || logText.includes('Variant B'));
        showResult(
          'test5-result',
          hasDecisionLog,
          hasDecisionLog
            ? `Found "Decision:" log with variant ${result.variant.label}`
            : 'Missing "Decision:" log entry'
        );

      } catch (error) {
        console.error('Test execution failed:', error);
        showResult('test1-result', false, `Error: ${error.message}`);
        showResult('test2-result', false, `Error: ${error.message}`);
        showResult('test3-result', false, `Error: ${error.message}`);
        showResult('test4-result', false, `Error: ${error.message}`);
        showResult('test5-result', false, `Error: ${error.message}`);
      }
    }

    // Run tests when page loads
    window.addEventListener('load', runTests);
  </script>
</body>
</html>
