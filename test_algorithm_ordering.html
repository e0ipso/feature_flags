<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature Flags - Algorithm Ordering Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
      color: #333;
    }
    h1 {
      color: #0678be;
      border-bottom: 3px solid #0678be;
      padding-bottom: 10px;
    }
    h2 {
      color: #333;
      margin-top: 30px;
      padding: 10px;
      background-color: #f5f5f5;
      border-left: 4px solid #0678be;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #fafafa;
    }
    .result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
    }
    .pass {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .fail {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .summary {
      margin-top: 30px;
      padding: 20px;
      background-color: #e7f3ff;
      border: 2px solid #0678be;
      border-radius: 4px;
    }
    code {
      background-color: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
    pre {
      background-color: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Feature Flags - Algorithm Ordering Test</h1>

  <div class="info">
    <strong>Test #66: Algorithms are evaluated in order by weight</strong>
    <p>Configuration: Feature flag with 3 algorithms at different weights. Algorithms should be evaluated from lowest to highest weight, with the first matching algorithm winning.</p>
    <ul>
      <li><strong>Algorithm 0 (weight 0):</strong> User ID condition for ['1'], returns "First Match" variant</li>
      <li><strong>Algorithm 1 (weight 1):</strong> User ID condition for ['2'], returns "Second Match" variant</li>
      <li><strong>Algorithm 2 (weight 2):</strong> No conditions (catch-all), returns "Catch-all" variant</li>
    </ul>
    <p><strong>Expected Behavior:</strong> Lower weight algorithms are evaluated first, first match wins</p>
  </div>

  <div id="results"></div>

  <!-- Setup drupalSettings -->
  <script>
    window.drupalSettings = {
      featureFlags: {
        settings: {
          debug: false,
          persist: false
        },
        flags: {
          algorithm_ordering_test: {
            id: 'algorithm_ordering_test',
            label: 'Algorithm Ordering Test',
            enabled: true,
            variants: [
              {
                uuid: 'variant-first',
                label: 'First Match',
                value: { message: 'First algorithm matched (weight 0)' }
              },
              {
                uuid: 'variant-second',
                label: 'Second Match',
                value: { message: 'Second algorithm matched (weight 1)' }
              },
              {
                uuid: 'variant-catchall',
                label: 'Catch-all',
                value: { message: 'Catch-all algorithm matched (weight 2)' }
              }
            ],
            algorithms: [
              {
                uuid: 'algo-1',
                pluginId: 'percentage_rollout',
                jsClass: 'PercentageRollout',
                weight: 0,
                configuration: {
                  percentages: {
                    'variant-first': 100,
                    'variant-second': 0,
                    'variant-catchall': 0
                  }
                },
                conditions: [
                  {
                    uuid: 'cond-1',
                    pluginId: 'user_id',
                    jsClass: 'UserIdCondition',
                    operator: 'OR',
                    negate: false,
                    configuration: {
                      values: ['1']
                    }
                  }
                ]
              },
              {
                uuid: 'algo-2',
                pluginId: 'percentage_rollout',
                jsClass: 'PercentageRollout',
                weight: 1,
                configuration: {
                  percentages: {
                    'variant-first': 0,
                    'variant-second': 100,
                    'variant-catchall': 0
                  }
                },
                conditions: [
                  {
                    uuid: 'cond-2',
                    pluginId: 'user_id',
                    jsClass: 'UserIdCondition',
                    operator: 'OR',
                    negate: false,
                    configuration: {
                      values: ['2']
                    }
                  }
                ]
              },
              {
                uuid: 'algo-3',
                pluginId: 'percentage_rollout',
                jsClass: 'PercentageRollout',
                weight: 2,
                configuration: {
                  percentages: {
                    'variant-first': 0,
                    'variant-second': 0,
                    'variant-catchall': 100
                  }
                },
                conditions: []
              }
            ]
          }
        },
        libraries: {
          algorithms: {
            'percentage_rollout': 'PercentageRollout'
          },
          conditions: {
            'user_id': 'UserIdCondition'
          }
        }
      }
    };
  </script>

  <!-- Load Feature Flag JS files -->
  <script src="js/base/BaseCondition.js"></script>
  <script src="js/base/BaseAlgorithm.js"></script>
  <script src="js/base/FeatureFlagResult.js"></script>
  <script src="js/base/FeatureFlagConfig.js"></script>
  <script src="js/base/FeatureFlagManager.js"></script>
  <script src="js/condition/UserId.js"></script>
  <script src="js/condition/UserTier.js"></script>
  <script src="js/algorithm/PercentageRollout.js"></script>

  <script>
    const resultsDiv = document.getElementById('results');

    // Test helper functions
    function createTestSection(title, description) {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.innerHTML = `<h2>${title}</h2><p>${description}</p>`;
      resultsDiv.appendChild(section);
      return section;
    }

    function addResult(section, label, value, isPass, details = '') {
      const result = document.createElement('div');
      result.className = `result ${isPass ? 'pass' : 'fail'}`;
      result.innerHTML = `
        <strong>${label}:</strong> ${value}<br>
        ${details ? `<em>${details}</em><br>` : ''}
        <strong>Result: ${isPass ? '✓ PASS' : '✗ FAIL'}</strong>
      `;
      section.appendChild(result);
      return isPass;
    }

    // Run tests
    async function runTests() {
      const testResults = [];

      // Initialize the manager
      const manager = new FeatureFlagManager();

      // Test 1: User ID '1' should match first algorithm (weight 0)
      {
        const section = createTestSection(
          'Test 1: user_id = "1" (matches first algorithm at weight 0)',
          'Expected: First Match variant from algorithm with weight 0'
        );

        const manager1 = new FeatureFlagManager();

        // Provide context through event
        document.addEventListener('featureFlags:provideContext', (event) => {
          event.detail.addContext('user_id', '1');
        }, { once: true });

        const result = await manager1.resolve('algorithm_ordering_test');

        const variantUuid = result.variant?.uuid || 'unknown';
        const variantLabel = result.variant?.label || 'unknown';
        const expectedUuid = 'variant-first';
        const expectedLabel = 'First Match';

        const pass = variantUuid === expectedUuid && variantLabel === expectedLabel;

        testResults.push(addResult(
          section,
          'Variant UUID',
          variantUuid,
          pass,
          `Expected: ${expectedUuid}, Status: "${result.status}"`
        ));

        addResult(section, 'Variant Label', variantLabel, pass, `Expected: ${expectedLabel}`);
      }

      // Test 2: User ID '2' should match second algorithm (weight 1)
      {
        const section = createTestSection(
          'Test 2: user_id = "2" (matches second algorithm at weight 1)',
          'Expected: Second Match variant from algorithm with weight 1'
        );

        const manager2 = new FeatureFlagManager();

        document.addEventListener('featureFlags:provideContext', (event) => {
          event.detail.addContext('user_id', '2');
        }, { once: true });

        const result = await manager2.resolve('algorithm_ordering_test');

        const variantUuid = result.variant?.uuid || 'unknown';
        const variantLabel = result.variant?.label || 'unknown';
        const expectedUuid = 'variant-second';
        const expectedLabel = 'Second Match';

        const pass = variantUuid === expectedUuid && variantLabel === expectedLabel;

        testResults.push(addResult(
          section,
          'Variant UUID',
          variantUuid,
          pass,
          `Expected: ${expectedUuid}, Status: "${result.status}"`
        ));

        addResult(section, 'Variant Label', variantLabel, pass, `Expected: ${expectedLabel}`);
      }

      // Test 3: User ID '99' should match catch-all algorithm (weight 2)
      {
        const section = createTestSection(
          'Test 3: user_id = "99" (no specific match, falls to catch-all at weight 2)',
          'Expected: Catch-all variant from algorithm with weight 2'
        );

        const manager3 = new FeatureFlagManager();

        document.addEventListener('featureFlags:provideContext', (event) => {
          event.detail.addContext('user_id', '99');
        }, { once: true });

        const result = await manager3.resolve('algorithm_ordering_test');

        const variantUuid = result.variant?.uuid || 'unknown';
        const variantLabel = result.variant?.label || 'unknown';
        const expectedUuid = 'variant-catchall';
        const expectedLabel = 'Catch-all';

        const pass = variantUuid === expectedUuid && variantLabel === expectedLabel;

        testResults.push(addResult(
          section,
          'Variant UUID',
          variantUuid,
          pass,
          `Expected: ${expectedUuid}, Status: "${result.status}"`
        ));

        addResult(section, 'Variant Label', variantLabel, pass, `Expected: ${expectedLabel}`);
      }

      // Test 4: Verify algorithm ordering with overlapping conditions
      // If we had user_id='1' match BOTH first and catch-all, first should win
      {
        const section = createTestSection(
          'Test 4: Verify first matching algorithm wins (lower weight has priority)',
          'Expected: Even though catch-all would match, the first algorithm (weight 0) should win'
        );

        const manager4 = new FeatureFlagManager();

        document.addEventListener('featureFlags:provideContext', (event) => {
          event.detail.addContext('user_id', '1');
        }, { once: true });

        const result = await manager4.resolve('algorithm_ordering_test');

        const variantUuid = result.variant?.uuid || 'unknown';
        const variantLabel = result.variant?.label || 'unknown';
        const expectedUuid = 'variant-first';
        const expectedLabel = 'First Match';

        // Should NOT be catch-all
        const notCatchall = variantUuid !== 'variant-catchall';
        const isFirst = variantUuid === expectedUuid;
        const pass = notCatchall && isFirst;

        testResults.push(addResult(
          section,
          'Variant UUID',
          variantUuid,
          pass,
          `Expected: ${expectedUuid} (NOT variant-catchall), Status: "${result.status}"`
        ));

        addResult(section, 'Variant Label', variantLabel, pass, `Expected: ${expectedLabel} (NOT Catch-all)`);
      }

      // Test 5: Verify middle algorithm can be reached
      {
        const section = createTestSection(
          'Test 5: Verify middle-weight algorithm is reachable',
          'Expected: When first algorithm does not match but second does, second should win'
        );

        const manager5 = new FeatureFlagManager();

        document.addEventListener('featureFlags:provideContext', (event) => {
          event.detail.addContext('user_id', '2');
        }, { once: true });

        const result = await manager5.resolve('algorithm_ordering_test');

        const variantUuid = result.variant?.uuid || 'unknown';
        const variantLabel = result.variant?.label || 'unknown';
        const expectedUuid = 'variant-second';
        const expectedLabel = 'Second Match';

        // Should NOT be first or catch-all
        const notFirst = variantUuid !== 'variant-first';
        const notCatchall = variantUuid !== 'variant-catchall';
        const isSecond = variantUuid === expectedUuid;
        const pass = notFirst && notCatchall && isSecond;

        testResults.push(addResult(
          section,
          'Variant UUID',
          variantUuid,
          pass,
          `Expected: ${expectedUuid}, Status: "${result.status}"`
        ));

        addResult(section, 'Variant Label', variantLabel, pass, `Expected: ${expectedLabel}`);
      }

      // Summary
      const summary = document.createElement('div');
      summary.className = 'summary';
      const passCount = testResults.filter(r => r).length;
      const totalCount = testResults.length;
      const allPass = passCount === totalCount;

      summary.innerHTML = `
        <h2>Summary</h2>
        <p><strong>${allPass ? '✓ PASS' : '✗ FAIL'}: Algorithms are evaluated in order by weight</strong></p>
        <p>Tests passed: ${passCount}/${totalCount}</p>
        <ul>
          <li>Lower weight algorithms are evaluated first</li>
          <li>First matching algorithm wins (stops evaluation)</li>
          <li>Higher weight algorithms are only reached if lower ones don't match</li>
          <li>Catch-all algorithms (no conditions) at highest weight serve as fallback</li>
        </ul>
        ${allPass ? '<p style="color: #155724;"><strong>Algorithm ordering works correctly!</strong></p>' : '<p style="color: #721c24;"><strong>Algorithm ordering has issues - review test results above</strong></p>'}
      `;
      resultsDiv.appendChild(summary);
    }

    // Run tests on page load
    runTests().catch(error => {
      console.error('Test execution failed:', error);
      resultsDiv.innerHTML += `<div class="result fail"><strong>Error:</strong> ${error.message}</div>`;
    });
  </script>
</body>
</html>
