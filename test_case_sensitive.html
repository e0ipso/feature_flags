<!DOCTYPE html>
<html>
<head>
    <title>Feature Flags - Case-Sensitive User Tier Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        h1 { color: #0678BE; }
        .test-section { margin: 20px 0; padding: 15px; border-left: 4px solid #0678BE; background: #f5f5f5; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        .info { color: #666; }
        .warning { color: orange; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Feature Flags - Case-Sensitive User Tier Test</h1>
    <div id="results"></div>

    <!-- Mock Drupal settings -->
    <script>
        window.drupalSettings = {
            featureFlags: {
                settings: {
                    debug: true,
                    persist: false
                },
                flags: {},
                libraries: {}
            }
        };
    </script>

    <!-- Load the JavaScript files -->
    <script src="js/base/BaseCondition.js"></script>
    <script src="js/base/BaseAlgorithm.js"></script>
    <script src="js/base/FeatureFlagResult.js"></script>
    <script src="js/base/FeatureFlagConfig.js"></script>
    <script src="js/base/FeatureFlagManager.js"></script>
    <script src="js/condition/UserTier.js"></script>
    <script src="js/algorithm/PercentageRollout.js"></script>

    <script>
        const results = document.getElementById('results');

        function log(message, cssClass = '') {
            const div = document.createElement('div');
            div.innerHTML = message;
            if (cssClass) {
                div.className = cssClass;
            }
            results.appendChild(div);
            console.log(message);
        }

        // Test configuration: User Tier condition for 'premium' (lowercase only)
        drupalSettings.featureFlags.flags.case_sensitive_test = {
            id: 'case_sensitive_test',
            label: 'Case-Sensitive Test',
            enabled: true,
            variants: [
                {
                    uuid: 'variant-matched',
                    label: 'Matched (Conditional)',
                    value: { status: 'Condition matched - exact case' }
                },
                {
                    uuid: 'variant-not-matched',
                    label: 'Not Matched (Catch-all)',
                    value: { status: 'Condition did not match - case mismatch or not in list' }
                }
            ],
            algorithms: [
                {
                    uuid: 'algo-case-sensitive',
                    pluginId: 'percentage_rollout',
                    jsClass: 'PercentageRollout',
                    configuration: {
                        percentages: {
                            'variant-matched': 100,
                            'variant-not-matched': 0
                        }
                    },
                    conditions: [
                        {
                            uuid: 'tier-condition-lowercase',
                            pluginId: 'user_tier',
                            jsClass: 'UserTierCondition',
                            operator: 'OR',
                            configuration: {
                                values: ['premium']  // Only lowercase 'premium'
                            }
                        }
                    ],
                    weight: 0
                },
                {
                    uuid: 'algo-catch-all',
                    pluginId: 'percentage_rollout',
                    jsClass: 'PercentageRollout',
                    configuration: {
                        percentages: {
                            'variant-matched': 0,
                            'variant-not-matched': 100
                        }
                    },
                    conditions: [],
                    weight: 1
                }
            ]
        };

        // Run tests asynchronously
        async function runTests() {
            try {
                const manager = new FeatureFlagManager();

                log('<div class="test-section">', '');
                log('<h2>Test #64: User Tier condition matching is case-sensitive</h2>');
                log('<p class="info">Configuration: User Tier condition for ["premium"] (lowercase only)</p>');
                log('<p class="warning">⚠ Matching should be case-sensitive per spec</p>');
                log('</div>');

                log('<div class="test-section">', '');
                log('<h2>Test 1: user_tier = "Premium" (capital P - case mismatch)</h2>');
                log('<p class="info">Expected: Should NOT match due to case difference, use catch-all</p>');

                manager.initialContext = { user_tier: 'Premium' };
                const result1 = await manager.resolve('case_sensitive_test');

                log(`<p>Variant UUID: <strong>${result1.variant.uuid}</strong></p>`);
                log(`<p>Variant Label: <strong>${result1.variant.label}</strong></p>`);
                log(`<p>Status: ${JSON.stringify(result1.result.status)}</p>`);

                if (result1.variant.uuid === 'variant-not-matched') {
                    log('<p class="pass">✅ PASS: "Premium" did NOT match "premium" (case-sensitive matching works)</p>');
                } else {
                    log('<p class="fail">❌ FAIL: Should NOT have matched due to case difference</p>');
                }
                log('</div>');

                log('<div class="test-section">', '');
                log('<h2>Test 2: user_tier = "premium" (lowercase - exact match)</h2>');
                log('<p class="info">Expected: Should match exactly, use conditional algorithm</p>');

                manager.initialContext = { user_tier: 'premium' };
                const result2 = await manager.resolve('case_sensitive_test');

                log(`<p>Variant UUID: <strong>${result2.variant.uuid}</strong></p>`);
                log(`<p>Variant Label: <strong>${result2.variant.label}</strong></p>`);
                log(`<p>Status: ${JSON.stringify(result2.result.status)}</p>`);

                if (result2.variant.uuid === 'variant-matched') {
                    log('<p class="pass">✅ PASS: "premium" matched "premium" (exact case match works)</p>');
                } else {
                    log('<p class="fail">❌ FAIL: Should have matched with exact case</p>');
                }
                log('</div>');

                log('<div class="test-section">', '');
                log('<h2>Test 3: user_tier = "PREMIUM" (all caps - case mismatch)</h2>');
                log('<p class="info">Expected: Should NOT match due to case difference, use catch-all</p>');

                manager.initialContext = { user_tier: 'PREMIUM' };
                const result3 = await manager.resolve('case_sensitive_test');

                log(`<p>Variant UUID: <strong>${result3.variant.uuid}</strong></p>`);
                log(`<p>Variant Label: <strong>${result3.variant.label}</strong></p>`);
                log(`<p>Status: ${JSON.stringify(result3.result.status)}</p>`);

                if (result3.variant.uuid === 'variant-not-matched') {
                    log('<p class="pass">✅ PASS: "PREMIUM" did NOT match "premium" (case-sensitive matching works)</p>');
                } else {
                    log('<p class="fail">❌ FAIL: Should NOT have matched due to case difference</p>');
                }
                log('</div>');

                log('<div class="test-section">', '');
                log('<h2>Test 4: user_tier = "PrEmIuM" (mixed case - case mismatch)</h2>');
                log('<p class="info">Expected: Should NOT match due to case difference, use catch-all</p>');

                manager.initialContext = { user_tier: 'PrEmIuM' };
                const result4 = await manager.resolve('case_sensitive_test');

                log(`<p>Variant UUID: <strong>${result4.variant.uuid}</strong></p>`);
                log(`<p>Variant Label: <strong>${result4.variant.label}</strong></p>`);
                log(`<p>Status: ${JSON.stringify(result4.result.status)}</p>`);

                if (result4.variant.uuid === 'variant-not-matched') {
                    log('<p class="pass">✅ PASS: "PrEmIuM" did NOT match "premium" (case-sensitive matching works)</p>');
                } else {
                    log('<p class="fail">❌ FAIL: Should NOT have matched due to case difference</p>');
                }
                log('</div>');

                log('<div class="test-section">', '');
                log('<h2>Summary</h2>');
                log('<p class="pass">✅ User Tier condition matching is case-sensitive</p>');
                log('<p class="info">Only exact case matches will trigger the condition</p>');
                log('<p class="info">Any case variation (Premium, PREMIUM, PrEmIuM) will NOT match "premium"</p>');
                log('<p class="info">This allows for precise tier matching in production systems</p>');
                log('</div>');

            } catch (error) {
                log(`<p class="fail">ERROR: ${error.message}</p>`);
                console.error(error);
            }
        }

        // Run the tests when page loads
        runTests();
    </script>
</body>
</html>
