<project_specification>
  <project_name>Feature Flags - Drupal Module</project_name>

  <overview>
    Build a Drupal module for client-side feature flag management and execution. The module enables site 
    administrators to create feature flags with multiple variants, configure decision algorithms (with 
    conditions), and resolve variants client-side via JavaScript—allowing personalized experiences even 
    behind caching layers. The architecture follows the plugin pattern established by the Lullabot ab_tests 
    module, with PHP plugins paired with corresponding JavaScript classes.
  </overview>

  <compatibility>
    <drupal_versions>Drupal 10.3.x, 10.4.x, 11.0.x, 11.1.x</drupal_versions>
    <php_version>PHP 8.2+ (use PHP 8.2 language features: readonly properties, enums, named arguments, etc.)</php_version>
    <no_build_step>No JavaScript build step required - use ES6 classes, CDN libraries only</no_build_step>
  </compatibility>

  <technology_stack>
    <module_name>feature_flags</module_name>
    <namespace>Drupal\feature_flags</namespace>
    <php>
      <version>8.2+</version>
      <features>Readonly properties, constructor property promotion, enums, named arguments, match expressions, union types</features>
      <testing>PHPUnit</testing>
    </php>
    <javascript>
      <style>ES6 classes</style>
      <testing>Jest</testing>
      <json_editor>CodeMirror 5 via CDN (cdnjs.cloudflare.com) with JSON mode and linting</json_editor>
    </javascript>
    <drupal_apis>
      <config_entity>For storing feature flag configurations</config_entity>
      <plugin_system>For decision algorithms and conditions</plugin_system>
      <form_api>For admin configuration forms with AJAX</form_api>
      <library_system>For JavaScript asset management</library_system>
      <settings_form>For module-wide settings</settings_form>
    </drupal_apis>
  </technology_stack>

  <module_structure>
    <directories>
      feature_flags/
      ├── config/
      │   ├── install/
      │   │   └── feature_flags.settings.yml
      │   └── schema/
      │       ├── feature_flags.schema.yml
      │       └── feature_flags.data_types.schema.yml
      ├── js/
      │   ├── base/
      │   │   ├── BaseAlgorithm.js
      │   │   ├── BaseCondition.js
      │   │   ├── FeatureFlagManager.js
      │   │   ├── FeatureFlagResult.js
      │   │   └── FeatureFlagConfig.js
      │   ├── algorithm/
      │   │   └── PercentageRollout.js
      │   ├── condition/
      │   │   ├── UserId.js
      │   │   └── UserTier.js
      │   ├── feature_flags.js
      │   └── json_editor.js
      ├── src/
      │   ├── Annotation/
      │   │   ├── DecisionAlgorithm.php
      │   │   └── AlgorithmCondition.php
      │   ├── Entity/
      │   │   └── FeatureFlag.php
      │   ├── Form/
      │   │   ├── FeatureFlagForm.php
      │   │   ├── FeatureFlagDeleteForm.php
      │   │   └── SettingsForm.php
      │   ├── Plugin/
      │   │   ├── DecisionAlgorithm/
      │   │   │   ├── DecisionAlgorithmInterface.php
      │   │   │   ├── DecisionAlgorithmPluginBase.php
      │   │   │   └── PercentageRollout.php
      │   │   └── AlgorithmCondition/
      │   │       ├── AlgorithmConditionInterface.php
      │   │       ├── AlgorithmConditionPluginBase.php
      │   │       ├── UserId.php
      │   │       └── UserTier.php
      │   ├── FeatureFlagListBuilder.php
      │   └── FeatureFlagManagerInterface.php
      ├── tests/
      │   ├── src/
      │   │   ├── Unit/
      │   │   │   ├── Plugin/
      │   │   │   │   ├── DecisionAlgorithm/
      │   │   │   │   │   └── PercentageRolloutTest.php
      │   │   │   │   └── AlgorithmCondition/
      │   │   │   │       ├── UserIdTest.php
      │   │   │   │       └── UserTierTest.php
      │   │   │   └── Entity/
      │   │   │       └── FeatureFlagTest.php
      │   │   └── Kernel/
      │   │       └── FeatureFlagEntityTest.php
      │   └── js/
      │       ├── jest.config.js
      │       ├── setup.js
      │       ├── base/
      │       │   ├── FeatureFlagManager.test.js
      │       │   └── FeatureFlagResult.test.js
      │       ├── algorithm/
      │       │   └── PercentageRollout.test.js
      │       └── condition/
      │           ├── UserId.test.js
      │           └── UserTier.test.js
      ├── feature_flags.info.yml
      ├── feature_flags.routing.yml
      ├── feature_flags.links.menu.yml
      ├── feature_flags.links.task.yml
      ├── feature_flags.links.action.yml
      ├── feature_flags.libraries.yml
      ├── feature_flags.services.yml
      ├── feature_flags.permissions.yml
      └── feature_flags.module
    </directories>
  </module_structure>

  <admin_interface>
    <menu_structure>
      <parent_path>/admin/config/services</parent_path>
      <main_path>/admin/config/services/feature-flags</main_path>
      <settings_path>/admin/config/services/feature-flags/settings</settings_path>
      <list_path>/admin/config/services/feature-flags/list</list_path>
      <add_path>/admin/config/services/feature-flags/add</add_path>
      <edit_path>/admin/config/services/feature-flags/{feature_flag}/edit</edit_path>
      <delete_path>/admin/config/services/feature-flags/{feature_flag}/delete</delete_path>
    </menu_structure>

    <tabs>
      <default_tab>Settings (at /admin/config/services/feature-flags)</default_tab>
      <secondary_tab>Feature Flags (config entity listing at /admin/config/services/feature-flags/list)</secondary_tab>
    </tabs>

    <settings_form>
      <path>/admin/config/services/feature-flags</path>
      <fields>
        <debug_mode>
          <type>checkbox</type>
          <label>Debug mode</label>
          <description>When enabled, the JavaScript client will log decision-making details to the browser console using console.debug().</description>
          <default>false</default>
        </debug_mode>
        <persist_decisions>
          <type>checkbox</type>
          <label>Persist decisions</label>
          <description>When enabled, feature flag decisions will be stored in localStorage for consistent user experiences across page loads.</description>
          <default>false</default>
        </persist_decisions>
        <exclude_from_config_export>
          <type>checkbox</type>
          <label>Exclude from configuration export</label>
          <description>When enabled, feature flag configurations will be excluded during configuration export/import operations.</description>
          <default>false</default>
        </exclude_from_config_export>
      </fields>
    </settings_form>

    <feature_flag_list>
      <path>/admin/config/services/feature-flags/list</path>
      <columns>
        <label>Label (linked to edit form)</label>
        <machine_name>Machine name</machine_name>
        <status>Status (enabled/disabled badge)</status>
        <variants_count>Number of variants</variants_count>
        <algorithms_count>Number of algorithms</algorithms_count>
        <operations>Edit, Delete</operations>
      </columns>
      <empty_state>No feature flags have been created yet.</empty_state>
      <add_action>Add feature flag (local action button)</add_action>
    </feature_flag_list>
  </admin_interface>

  <config_entity>
    <entity_type>feature_flag</entity_type>
    <entity_class>Drupal\feature_flags\Entity\FeatureFlag</entity_class>
    <label>Feature Flag</label>
    <label_plural>Feature Flags</label_plural>

    <properties>
      <id>
        <type>string</type>
        <description>Machine name, auto-generated from label using Drupal machine_name form element</description>
        <max_length>64</max_length>
      </id>
      <label>
        <type>string</type>
        <description>Human-readable name</description>
        <required>true</required>
      </label>
      <description>
        <type>string</type>
        <description>Internal documentation/notes about this feature flag</description>
        <required>false</required>
      </description>
      <status>
        <type>boolean</type>
        <description>Whether the feature flag is enabled</description>
        <default>true</default>
      </status>
      <variants>
        <type>array</type>
        <description>List of variant definitions</description>
        <min_items>2</min_items>
        <item_structure>
          <uuid>
            <type>string</type>
            <format>UUID v4</format>
            <auto_generated>true</auto_generated>
            <editable>false</editable>
            <visible_in_form>false</visible_in_form>
          </uuid>
          <label>
            <type>string</type>
            <required>true</required>
          </label>
          <value>
            <type>string</type>
            <format>JSON</format>
            <description>JSON-encoded variant value</description>
            <required>true</required>
          </value>
        </item_structure>
      </variants>
      <algorithms>
        <type>array</type>
        <description>Ordered list of decision algorithms with conditions</description>
        <min_items>1</min_items>
        <item_structure>
          <uuid>
            <type>string</type>
            <format>UUID v4</format>
            <auto_generated>true</auto_generated>
            <description>Unique identifier for this algorithm instance</description>
          </uuid>
          <plugin_id>
            <type>string</type>
            <description>Decision algorithm plugin ID</description>
          </plugin_id>
          <configuration>
            <type>array</type>
            <description>Plugin-specific configuration (e.g., variant percentages)</description>
          </configuration>
          <conditions>
            <type>array</type>
            <description>List of conditions that must be met for this algorithm to apply</description>
            <item_structure>
              <uuid>
                <type>string</type>
                <format>UUID v4</format>
                <auto_generated>true</auto_generated>
              </uuid>
              <plugin_id>
                <type>string</type>
                <description>Condition plugin ID</description>
              </plugin_id>
              <operator>
                <type>string</type>
                <enum>["AND", "OR", "NOT"]</enum>
                <description>Logical operator for this condition instance</description>
              </operator>
              <configuration>
                <type>array</type>
                <description>Plugin-specific configuration (e.g., user IDs to match)</description>
              </configuration>
            </item_structure>
          </conditions>
          <weight>
            <type>integer</type>
            <description>Order weight for drag-and-drop sorting</description>
            <default>0</default>
          </weight>
        </item_structure>
      </algorithms>
    </properties>

    <validation_rules>
      <variants_minimum>At least 2 variants must be defined</variants_minimum>
      <catch_all_algorithm>At least one algorithm must have no conditions (catch-all)</catch_all_algorithm>
      <percentage_sum>Percentage rollout algorithms must have percentages summing to exactly 100%</percentage_sum>
      <unique_variant_labels>Variant labels should be unique within a feature flag</unique_variant_labels>
      <valid_json>Variant values must be valid JSON</valid_json>
    </validation_rules>
  </config_entity>

  <feature_flag_form>
    <layout>Vertical tabs</layout>
    
    <tabs>
      <basic_info>
        <label>Basic Information</label>
        <fields>
          <label>
            <type>textfield</type>
            <title>Label</title>
            <required>true</required>
          </label>
          <id>
            <type>machine_name</type>
            <title>Machine name</title>
            <source>label</source>
            <exists_callback>feature_flag_load</exists_callback>
          </id>
          <description>
            <type>textarea</type>
            <title>Description</title>
            <description>Internal notes about this feature flag</description>
            <required>false</required>
          </description>
          <status>
            <type>checkbox</type>
            <title>Enabled</title>
            <default>true</default>
          </status>
        </fields>
      </basic_info>

      <variants_tab>
        <label>Variants</label>
        <description>Define the possible values this feature flag can resolve to. Minimum 2 variants required.</description>
        <fields>
          <variants_wrapper>
            <type>container</type>
            <id>variants-wrapper</id>
            <children>
              <variant_items>
                <type>repeatable_fieldset</type>
                <add_button_text>Add variant</add_button_text>
                <remove_button_text>Remove</remove_button_text>
                <min_items>2</min_items>
                <item_fields>
                  <label>
                    <type>textfield</type>
                    <title>Variant label</title>
                    <required>true</required>
                  </label>
                  <value>
                    <type>textarea</type>
                    <title>Value (JSON)</title>
                    <required>true</required>
                    <attributes>
                      <class>json-editor-textarea</class>
                      <data-json-editor>true</data-json-editor>
                    </attributes>
                    <description>Enter a valid JSON value for this variant</description>
                  </value>
                </item_fields>
              </variant_items>
            </children>
          </variants_wrapper>
        </fields>
      </variants_tab>

      <algorithms_tab>
        <label>Decision Algorithms</label>
        <description>Configure algorithms that determine which variant a user receives. Algorithms are evaluated in order; the first one whose conditions are met will be used. At least one algorithm without conditions is required as a catch-all.</description>
        <fields>
          <algorithms_wrapper>
            <type>container</type>
            <id>algorithms-wrapper</id>
            <attributes>
              <class>algorithms-draggable-container</class>
            </attributes>
            <children>
              <algorithm_items>
                <type>draggable_table</type>
                <tabledrag>true</tabledrag>
                <item_wrapper>
                  <type>details</type>
                  <open>true</open>
                  <title_callback>Algorithm: {plugin_label}</title_callback>
                </item_wrapper>
                <item_fields>
                  <weight>
                    <type>weight</type>
                    <title>Weight</title>
                    <delta>50</delta>
                  </weight>
                  <plugin_id>
                    <type>hidden</type>
                  </plugin_id>
                  <plugin_configuration>
                    <type>container</type>
                    <description>Plugin-specific configuration form embedded via subform</description>
                  </plugin_configuration>
                  <conditions_section>
                    <type>details</type>
                    <title>Conditions</title>
                    <open>false</open>
                    <description>If no conditions are specified, this algorithm will always apply (catch-all).</description>
                    <children>
                      <conditions>
                        <type>repeatable_fieldset</type>
                        <add_button_text>Add condition</add_button_text>
                        <remove_button_text>Remove</remove_button_text>
                        <item_fields>
                          <condition_plugin_id>
                            <type>select</type>
                            <title>Condition type</title>
                            <options_callback>Get available condition plugins</options_callback>
                            <ajax>true</ajax>
                            <ajax_callback>Inject condition configuration form</ajax_callback>
                          </condition_plugin_id>
                          <operator>
                            <type>select</type>
                            <title>Operator</title>
                            <options>
                              <AND>AND (all values must match)</AND>
                              <OR>OR (any value must match)</OR>
                              <NOT>NOT (none of the values must match)</NOT>
                            </options>
                            <default>OR</default>
                          </operator>
                          <condition_configuration>
                            <type>container</type>
                            <description>Condition-specific configuration form embedded via subform</description>
                          </condition_configuration>
                        </item_fields>
                      </conditions>
                    </children>
                  </conditions_section>
                  <remove_button>
                    <type>submit</type>
                    <value>Remove algorithm</value>
                    <ajax>true</ajax>
                    <submit_callback>Remove this algorithm</submit_callback>
                  </remove_button>
                </item_fields>
              </algorithm_items>
              <add_algorithm_section>
                <type>details</type>
                <title>Add Algorithm</title>
                <open>false</open>
                <children>
                  <algorithm_plugin_select>
                    <type>radios</type>
                    <title>Select algorithm type</title>
                    <options_callback>Get available algorithm plugins with descriptions</options_callback>
                  </algorithm_plugin_select>
                  <add_algorithm_button>
                    <type>submit</type>
                    <value>Add algorithm</value>
                    <ajax>true</ajax>
                    <submit_callback>Add selected algorithm to the list</submit_callback>
                  </add_algorithm_button>
                </children>
              </add_algorithm_section>
            </children>
          </algorithms_wrapper>
        </fields>
      </algorithms_tab>
    </tabs>
  </feature_flag_form>

  <plugins>
    <decision_algorithms>
      <plugin_type>DecisionAlgorithm</plugin_type>
      <annotation_class>Drupal\feature_flags\Annotation\DecisionAlgorithm</annotation_class>
      <interface>Drupal\feature_flags\Plugin\DecisionAlgorithm\DecisionAlgorithmInterface</interface>
      <base_class>Drupal\feature_flags\Plugin\DecisionAlgorithm\DecisionAlgorithmPluginBase</base_class>
      <plugin_manager_service>plugin.manager.feature_flags.decision_algorithm</plugin_manager_service>
      
      <annotation_properties>
        <id>Plugin machine name</id>
        <label>Human-readable label</label>
        <description>Description shown in algorithm selection</description>
        <js_library>Drupal library name containing the JS class</js_library>
        <js_class>JavaScript class name that extends BaseAlgorithm</js_class>
      </annotation_properties>

      <interface_methods>
        <defaultConfiguration>Returns default plugin configuration array</defaultConfiguration>
        <buildConfigurationForm>Builds the plugin configuration form with access to variants via subform state</buildConfigurationForm>
        <validateConfigurationForm>Validates plugin configuration</validateConfigurationForm>
        <submitConfigurationForm>Processes submitted configuration</submitConfigurationForm>
        <getConfiguration>Returns current configuration</getConfiguration>
        <setConfiguration>Sets configuration array</setConfiguration>
        <getJavaScriptSettings>Returns settings to pass to JS class</getJavaScriptSettings>
      </interface_methods>

      <implementations>
        <percentage_rollout>
          <id>percentage_rollout</id>
          <label>Percentage Rollout</label>
          <description>Distribute users across variants based on configurable percentages. When persistence is enabled, users consistently receive the same variant.</description>
          <js_library>feature_flags/algorithm.percentage_rollout</js_library>
          <js_class>PercentageRollout</js_class>
          <configuration>
            <percentages>
              <type>array</type>
              <description>Map of variant UUID to percentage (0-100)</description>
              <example>{"uuid-1": 50, "uuid-2": 25, "uuid-3": 25}</example>
            </percentages>
          </configuration>
          <form_behavior>
            <variant_access>Read available variants from parent form via SubformState::getCompleteFormState()</variant_access>
            <display>Show all variants with a number input (0-100) for percentage next to each</display>
            <validation>Sum of all percentages must equal exactly 100</validation>
          </form_behavior>
        </percentage_rollout>
      </implementations>
    </decision_algorithms>

    <algorithm_conditions>
      <plugin_type>AlgorithmCondition</plugin_type>
      <annotation_class>Drupal\feature_flags\Annotation\AlgorithmCondition</annotation_class>
      <interface>Drupal\feature_flags\Plugin\AlgorithmCondition\AlgorithmConditionInterface</interface>
      <base_class>Drupal\feature_flags\Plugin\AlgorithmCondition\AlgorithmConditionPluginBase</base_class>
      <plugin_manager_service>plugin.manager.feature_flags.algorithm_condition</plugin_manager_service>

      <annotation_properties>
        <id>Plugin machine name</id>
        <label>Human-readable label</label>
        <description>Description of what this condition evaluates</description>
        <context_key>The key in the context object this condition reads from</context_key>
        <js_library>Drupal library name containing the JS class</js_library>
        <js_class>JavaScript class name that extends BaseCondition</js_class>
      </annotation_properties>

      <interface_methods>
        <defaultConfiguration>Returns default plugin configuration array</defaultConfiguration>
        <buildConfigurationForm>Builds the plugin configuration form</buildConfigurationForm>
        <validateConfigurationForm>Validates plugin configuration</validateConfigurationForm>
        <submitConfigurationForm>Processes submitted configuration</submitConfigurationForm>
        <getConfiguration>Returns current configuration</getConfiguration>
        <setConfiguration>Sets configuration array</setConfiguration>
        <getJavaScriptSettings>Returns settings to pass to JS class</getJavaScriptSettings>
        <getContextKey>Returns the context key this condition reads from</getContextKey>
      </interface_methods>

      <implementations>
        <user_id>
          <id>user_id</id>
          <label>User ID</label>
          <description>Match against specific user IDs</description>
          <context_key>user_id</context_key>
          <js_library>feature_flags/condition.user_id</js_library>
          <js_class>UserIdCondition</js_class>
          <configuration>
            <values>
              <type>array of strings</type>
              <description>User IDs to match against</description>
            </values>
          </configuration>
          <form_fields>
            <values>
              <type>textfield</type>
              <title>User IDs</title>
              <description>Enter user IDs separated by commas (e.g., "1, 5, 10")</description>
            </values>
          </form_fields>
          <matching>Exact match, compared as strings</matching>
        </user_id>

        <user_tier>
          <id>user_tier</id>
          <label>User Tier</label>
          <description>Match against user tier values provided via page context</description>
          <context_key>user_tier</context_key>
          <js_library>feature_flags/condition.user_tier</js_library>
          <js_class>UserTierCondition</js_class>
          <configuration>
            <values>
              <type>array of strings</type>
              <description>Tier values to match against (e.g., "free", "premium", "enterprise")</description>
            </values>
          </configuration>
          <form_fields>
            <values>
              <type>textfield</type>
              <title>User Tiers</title>
              <description>Enter tier values separated by commas (e.g., "free, premium")</description>
            </values>
          </form_fields>
          <matching>Exact match, case-sensitive</matching>
        </user_tier>
      </implementations>
    </algorithm_conditions>
  </plugins>

  <javascript_architecture>
    <initialization>
      <method>Drupal.behaviors</method>
      <behavior_name>featureFlags</behavior_name>
      <global_instance>Drupal.featureFlags (FeatureFlagManager instance)</global_instance>
    </initialization>

    <context_event>
      <event_name>featureFlags:provideContext</event_name>
      <timing>Fires on each Drupal.behaviors attach</timing>
      <async_support>Yes - context providers can return Promises</async_support>
      <context_shape>Record&lt;string, scalar&gt; (scalar = string | number | boolean)</context_shape>
      <usage_example>
        document.addEventListener('featureFlags:provideContext', async (event) => {
          // Use Drupal's once() to prevent multiple registrations
          event.detail.addContext('user_id', drupalSettings.user.uid);
          event.detail.addContext('user_tier', await fetchUserTier());
        });
      </usage_example>
      <default_context>
        <user_id>If not provided, a randomly generated UUID is used</user_id>
      </default_context>
    </context_event>

    <classes>
      <FeatureFlagManager>
        <file>js/base/FeatureFlagManager.js</file>
        <description>Main entry point for resolving feature flags</description>
        <constructor_params>
          <context>Optional initial context object</context>
        </constructor_params>
        <methods>
          <resolve>
            <signature>async resolve(flagId: string): Promise&lt;FeatureFlagResult&gt;</signature>
            <description>Resolves a feature flag to a variant</description>
            <steps>
              1. Get flag configuration from drupalSettings.featureFlags[flagId]
              2. If persistence enabled and cached decision exists, return cached result
              3. Build context by dispatching featureFlags:provideContext event
              4. Iterate through algorithms in order
              5. For each algorithm, evaluate its conditions
              6. First algorithm with all conditions passing is used
              7. Execute algorithm's decide() method to get variant
              8. If persistence enabled, cache the decision
              9. Return FeatureFlagResult
            </steps>
          </resolve>
        </methods>
        <debug_logging>
          When debug mode enabled, log to console.debug:
          - "[Feature Flags] Resolving flag: {flagId}"
          - "[Feature Flags] Context: {context}"
          - "[Feature Flags] Evaluating algorithm: {algorithmId}"
          - "[Feature Flags] Condition {conditionId} ({operator}): {result}"
          - "[Feature Flags] Algorithm {algorithmId} conditions met: {result}"
          - "[Feature Flags] Decision: variant {variantLabel} ({variantUuid})"
        </debug_logging>
      </FeatureFlagManager>

      <FeatureFlagResult>
        <file>js/base/FeatureFlagResult.js</file>
        <description>Encapsulates the result of a feature flag resolution</description>
        <properties>
          <featureFlag>FeatureFlagConfig - the full flag configuration</featureFlag>
          <result>Object - the parsed JSON value of the selected variant</result>
          <variant>Object - the full variant object {uuid, label, value}</variant>
        </properties>
      </FeatureFlagResult>

      <FeatureFlagConfig>
        <file>js/base/FeatureFlagConfig.js</file>
        <description>Represents a feature flag configuration from drupalSettings</description>
        <properties>
          <id>string - machine name</id>
          <label>string - human label</label>
          <variants>array - variant definitions</variants>
          <algorithms>array - algorithm configurations</algorithms>
        </properties>
      </FeatureFlagConfig>

      <BaseAlgorithm>
        <file>js/base/BaseAlgorithm.js</file>
        <description>Abstract base class for decision algorithm JS implementations</description>
        <constructor_params>
          <variants>Array of variant objects from the feature flag</variants>
          <config>Algorithm configuration from PHP plugin</config>
        </constructor_params>
        <abstract_methods>
          <decide>
            <signature>async decide(context: Record&lt;string, scalar&gt;): Promise&lt;Variant&gt;</signature>
            <description>Returns the selected variant based on algorithm logic</description>
          </decide>
        </abstract_methods>
        <helper_methods>
          <getVariantByUuid>Find variant by UUID</getVariantByUuid>
          <hashString>Deterministic hash function for consistent bucketing</hashString>
        </helper_methods>
      </BaseAlgorithm>

      <BaseCondition>
        <file>js/base/BaseCondition.js</file>
        <description>Abstract base class for condition JS implementations</description>
        <constructor_params>
          <config>Condition configuration from PHP plugin</config>
          <operator>The operator: "AND", "OR", or "NOT"</operator>
        </constructor_params>
        <abstract_methods>
          <evaluate>
            <signature>evaluate(context: Record&lt;string, scalar&gt;): boolean</signature>
            <description>Returns whether the condition is satisfied</description>
          </evaluate>
        </abstract_methods>
        <helper_methods>
          <getContextValue>Get value from context by key</getContextValue>
          <applyOperator>Apply AND/OR/NOT logic to match results</applyOperator>
        </helper_methods>
      </BaseCondition>

      <PercentageRollout>
        <file>js/algorithm/PercentageRollout.js</file>
        <extends>BaseAlgorithm</extends>
        <description>Selects variant based on percentage distribution</description>
        <decide_logic>
          1. Get user_id from context (or use random UUID)
          2. If persistence enabled: hash(feature_flag_id + user_id) for deterministic bucket
          3. If persistence disabled: random number 0-99
          4. Map bucket to variant based on cumulative percentages
          5. Return selected variant
        </decide_logic>
      </PercentageRollout>

      <UserIdCondition>
        <file>js/condition/UserId.js</file>
        <extends>BaseCondition</extends>
        <description>Matches against user ID values</description>
        <evaluate_logic>
          1. Get user_id from context
          2. Check if user_id is in configured values array
          3. Apply operator (AND=all must match which doesn't apply here, OR=any match, NOT=no match)
          4. Return boolean result
        </evaluate_logic>
      </UserIdCondition>

      <UserTierCondition>
        <file>js/condition/UserTier.js</file>
        <extends>BaseCondition</extends>
        <description>Matches against user tier values</description>
        <evaluate_logic>
          1. Get user_tier from context
          2. Check if user_tier is in configured values array (case-sensitive)
          3. Apply operator
          4. Return boolean result
        </evaluate_logic>
      </UserTierCondition>
    </classes>

    <persistence>
      <storage>localStorage</storage>
      <key_format>feature_flags:{flag_id}</key_format>
      <stored_data>
        <variant_uuid>UUID of the selected variant</variant_uuid>
        <timestamp>When the decision was made</timestamp>
      </stored_data>
      <deterministic_hashing>
        <enabled_when>Persistence is enabled in module settings</enabled_when>
        <hash_input>feature_flag_id + user_id</hash_input>
        <hash_output>Number 0-99 for percentage bucketing</hash_output>
      </deterministic_hashing>
    </persistence>

    <drupal_settings_structure>
      drupalSettings.featureFlags = {
        settings: {
          debug: boolean,
          persist: boolean
        },
        flags: {
          "{flag_machine_name}": {
            id: string,
            label: string,
            variants: [
              { uuid: string, label: string, value: string (JSON) }
            ],
            algorithms: [
              {
                uuid: string,
                pluginId: string,
                jsClass: string,
                configuration: object,
                conditions: [
                  {
                    uuid: string,
                    pluginId: string,
                    jsClass: string,
                    operator: "AND" | "OR" | "NOT",
                    configuration: object
                  }
                ]
              }
            ]
          }
        },
        libraries: {
          algorithms: { "{plugin_id}": "{js_class_name}" },
          conditions: { "{plugin_id}": "{js_class_name}" }
        }
      }
    </drupal_settings_structure>
  </javascript_architecture>

  <json_editor>
    <library>CodeMirror 5</library>
    <cdn>cdnjs.cloudflare.com</cdn>
    <files>
      <css>
        - codemirror/5.65.x/codemirror.min.css
        - codemirror/5.65.x/addon/lint/lint.css
      </css>
      <js>
        - codemirror/5.65.x/codemirror.min.js
        - codemirror/5.65.x/mode/javascript/javascript.min.js
        - codemirror/5.65.x/addon/lint/lint.min.js
        - codemirror/5.65.x/addon/lint/json-lint.min.js
        - jsonlint/1.6.0/jsonlint.min.js
      </js>
    </files>
    <initialization>
      <selector>textarea[data-json-editor="true"]</selector>
      <options>
        mode: "application/json",
        lineNumbers: true,
        lineWrapping: true,
        matchBrackets: true,
        autoCloseBrackets: true,
        gutters: ["CodeMirror-lint-markers"],
        lint: true
      </options>
    </initialization>
    <drupal_integration>
      <library_name>feature_flags/json_editor</library_name>
      <behavior>Initialize CodeMirror on textareas with data-json-editor attribute</behavior>
      <form_sync>Sync CodeMirror content back to textarea on form submit</form_sync>
    </drupal_integration>
  </json_editor>

  <libraries>
    <feature_flags_base>
      <name>feature_flags/base</name>
      <js>
        - js/base/FeatureFlagConfig.js
        - js/base/FeatureFlagResult.js
        - js/base/BaseAlgorithm.js
        - js/base/BaseCondition.js
        - js/base/FeatureFlagManager.js
      </js>
      <dependencies>
        - core/drupal
        - core/drupalSettings
        - core/once
      </dependencies>
    </feature_flags_base>

    <feature_flags_main>
      <name>feature_flags/feature_flags</name>
      <js>
        - js/feature_flags.js
      </js>
      <dependencies>
        - feature_flags/base
      </dependencies>
    </feature_flags_main>

    <algorithm_percentage_rollout>
      <name>feature_flags/algorithm.percentage_rollout</name>
      <js>
        - js/algorithm/PercentageRollout.js
      </js>
      <dependencies>
        - feature_flags/base
      </dependencies>
    </algorithm_percentage_rollout>

    <condition_user_id>
      <name>feature_flags/condition.user_id</name>
      <js>
        - js/condition/UserId.js
      </js>
      <dependencies>
        - feature_flags/base
      </dependencies>
    </condition_user_id>

    <condition_user_tier>
      <name>feature_flags/condition.user_tier</name>
      <js>
        - js/condition/UserTier.js
      </js>
      <dependencies>
        - feature_flags/base
      </dependencies>
    </condition_user_tier>

    <json_editor>
      <name>feature_flags/json_editor</name>
      <css>
        - //cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css: { type: external }
        - //cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/lint.css: { type: external }
      </css>
      <js>
        - //cdnjs.cloudflare.com/ajax/libs/jsonlint/1.6.0/jsonlint.min.js: { type: external }
        - //cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js: { type: external }
        - //cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js: { type: external }
        - //cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/lint.min.js: { type: external }
        - //cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/json-lint.min.js: { type: external }
        - js/json_editor.js: {}
      </js>
      <dependencies>
        - core/drupal
        - core/once
      </dependencies>
    </json_editor>

    <admin_form>
      <name>feature_flags/admin_form</name>
      <js>
        - js/admin_form.js
      </js>
      <css>
        - css/admin_form.css
      </css>
      <dependencies>
        - core/drupal
        - core/jquery
        - core/drupal.ajax
        - feature_flags/json_editor
      </dependencies>
    </admin_form>
  </libraries>

  <config_export_exclusion>
    <implementation>
      Implement hook_config_export_collection_alter() or EventSubscriber for ConfigEvents::COLLECTION_INFO
      to conditionally exclude feature_flag config entities based on the exclude_from_config_export setting.
    </implementation>
    <pattern>Follow the ab_tests module pattern for config exclusion</pattern>
  </config_export_exclusion>

  <testing>
    <php_unit>
      <test_categories>
        <unit_tests>
          <location>tests/src/Unit/</location>
          <coverage>
            - Decision algorithm plugins (PercentageRollout)
            - Condition plugins (UserId, UserTier)
            - Config entity methods
            - Plugin configuration handling
          </coverage>
        </unit_tests>
        <kernel_tests>
          <location>tests/src/Kernel/</location>
          <coverage>
            - Config entity CRUD operations
            - Plugin manager discovery
            - Form building and validation
            - drupalSettings generation
          </coverage>
        </kernel_tests>
      </test_categories>

      <example_tests>
        <PercentageRolloutTest>
          - testDefaultConfiguration(): Verify default config structure
          - testBuildConfigurationForm(): Verify form elements are created
          - testValidateConfigurationFormInvalidSum(): Verify validation rejects non-100% sum
          - testValidateConfigurationFormValidSum(): Verify validation passes for 100%
          - testGetJavaScriptSettings(): Verify JS settings structure
        </PercentageRolloutTest>

        <UserIdConditionTest>
          - testDefaultConfiguration(): Verify default empty values
          - testBuildConfigurationForm(): Verify textfield for comma-separated IDs
          - testSubmitConfigurationForm(): Verify comma parsing to array
          - testGetJavaScriptSettings(): Verify values array in settings
        </UserIdConditionTest>

        <FeatureFlagEntityTest>
          - testEntityCreation(): Create and save feature flag
          - testVariantsValidation(): Verify minimum 2 variants enforced
          - testCatchAllAlgorithmValidation(): Verify catch-all requirement
          - testEntityDeletion(): Delete feature flag
        </FeatureFlagEntityTest>
      </example_tests>
    </php_unit>

    <jest>
      <location>tests/js/</location>
      <config_file>tests/js/jest.config.js</config_file>
      <setup_file>tests/js/setup.js</setup_file>

      <configuration>
        module.exports = {
          testEnvironment: 'jsdom',
          roots: ['&lt;rootDir&gt;'],
          moduleNameMapper: {
            '^@/(.*)$': '&lt;rootDir&gt;/../../js/$1'
          },
          setupFilesAfterEnv: ['&lt;rootDir&gt;/setup.js'],
          testMatch: ['**/*.test.js']
        };
      </configuration>

      <setup>
        // Mock Drupal global
        global.Drupal = {
          behaviors: {},
          t: (str) => str,
        };
        global.drupalSettings = {
          featureFlags: {
            settings: { debug: false, persist: false },
            flags: {},
            libraries: { algorithms: {}, conditions: {} }
          }
        };
        global.once = (id, selector) => document.querySelectorAll(selector);
      </setup>

      <test_files>
        <FeatureFlagManagerTest>
          - test resolves flag from drupalSettings
          - test fires context event
          - test evaluates algorithms in order
          - test returns first matching algorithm result
          - test uses catch-all when no conditions match
          - test caches decision when persistence enabled
          - test returns cached decision on subsequent calls
          - test debug logging when enabled
        </FeatureFlagManagerTest>

        <PercentageRolloutTest>
          - test constructor stores variants and config
          - test decide returns variant based on percentage
          - test deterministic hashing for same user
          - test different hash for different users
          - test handles edge case percentages (0%, 100%)
        </PercentageRolloutTest>

        <UserIdConditionTest>
          - test evaluate returns true when user_id matches (OR)
          - test evaluate returns false when user_id not in list (OR)
          - test NOT operator inverts result
          - test handles missing context key
        </UserIdConditionTest>

        <UserTierConditionTest>
          - test evaluate returns true when tier matches
          - test case-sensitive matching
          - test NOT operator inverts result
        </UserTierConditionTest>
      </test_files>
    </jest>

    <browser_testing>
      <framework>Playwright or Puppeteer (follow autonomous-coding harness pattern)</framework>
      <test_scenarios>
        <admin_interface>
          - Navigate to feature flags settings page
          - Enable debug mode
          - Navigate to feature flags list
          - Create a new feature flag with 2 variants
          - Add percentage rollout algorithm (50/50)
          - Add second algorithm with user_id condition
          - Verify drag-and-drop reordering
          - Save and verify entity created
          - Edit and verify form populates correctly
          - Delete and verify removal
        </admin_interface>
        <frontend_execution>
          - Load page with feature flag attached
          - Verify drupalSettings contains flag config
          - Verify context event fires
          - Verify decision is made
          - Verify decision persists (when enabled)
          - Verify debug console output (when enabled)
        </frontend_execution>
      </test_scenarios>
    </browser_testing>
  </testing>

  <implementation_steps>
    <step number="1">
      <title>Module Foundation</title>
      <tasks>
        - Create feature_flags.info.yml with Drupal 10/11 compatibility
        - Create feature_flags.module with hook implementations
        - Create feature_flags.services.yml with plugin managers
        - Create feature_flags.permissions.yml
        - Set up config schema files
        - Create default settings config
      </tasks>
    </step>

    <step number="2">
      <title>Plugin System</title>
      <tasks>
        - Create DecisionAlgorithm annotation and plugin manager
        - Create AlgorithmCondition annotation and plugin manager
        - Create DecisionAlgorithmInterface and base class
        - Create AlgorithmConditionInterface and base class
        - Implement PercentageRollout algorithm plugin
        - Implement UserId condition plugin
        - Implement UserTier condition plugin
      </tasks>
    </step>

    <step number="3">
      <title>Config Entity</title>
      <tasks>
        - Create FeatureFlag config entity class
        - Define entity annotation with forms, list builder
        - Create config schema for feature flag entity
        - Implement entity methods for variant/algorithm management
        - Create FeatureFlagListBuilder
      </tasks>
    </step>

    <step number="4">
      <title>Admin Forms</title>
      <tasks>
        - Create SettingsForm for module settings
        - Create FeatureFlagForm with vertical tabs
        - Implement variant management (add/remove with AJAX)
        - Implement algorithm management (add/remove/reorder with AJAX)
        - Implement condition management within algorithms
        - Create FeatureFlagDeleteForm
        - Wire up plugin configuration subforms
      </tasks>
    </step>

    <step number="5">
      <title>Routing and Menu</title>
      <tasks>
        - Create feature_flags.routing.yml with all routes
        - Create feature_flags.links.menu.yml for admin menu
        - Create feature_flags.links.task.yml for tabs
        - Create feature_flags.links.action.yml for "Add" action
      </tasks>
    </step>

    <step number="6">
      <title>JavaScript Base Classes</title>
      <tasks>
        - Create FeatureFlagConfig.js
        - Create FeatureFlagResult.js
        - Create BaseAlgorithm.js with helper methods
        - Create BaseCondition.js with operator logic
        - Create FeatureFlagManager.js with resolve logic
        - Create feature_flags.js (Drupal behavior initialization)
      </tasks>
    </step>

    <step number="7">
      <title>JavaScript Algorithm and Condition Implementations</title>
      <tasks>
        - Create PercentageRollout.js
        - Create UserId.js condition
        - Create UserTier.js condition
        - Implement deterministic hashing for persistence
        - Implement localStorage caching
      </tasks>
    </step>

    <step number="8">
      <title>JSON Editor Integration</title>
      <tasks>
        - Create feature_flags/json_editor library
        - Create json_editor.js behavior
        - Style CodeMirror for Drupal admin theme
        - Wire up form sync on submit
      </tasks>
    </step>

    <step number="9">
      <title>drupalSettings Integration</title>
      <tasks>
        - Implement hook_page_attachments to add feature flag settings
        - Generate proper JS settings structure from config entities
        - Load appropriate plugin JS libraries dynamically
        - Add debug and persistence settings
      </tasks>
    </step>

    <step number="10">
      <title>Config Export Exclusion</title>
      <tasks>
        - Implement config export exclusion mechanism
        - Follow ab_tests module pattern
        - Test config export/import with exclusion enabled/disabled
      </tasks>
    </step>

    <step number="11">
      <title>PHP Unit Tests</title>
      <tasks>
        - Write unit tests for algorithm plugins
        - Write unit tests for condition plugins
        - Write kernel tests for config entity
        - Write kernel tests for form validation
      </tasks>
    </step>

    <step number="12">
      <title>Jest Tests</title>
      <tasks>
        - Set up Jest configuration
        - Write tests for FeatureFlagManager
        - Write tests for PercentageRollout algorithm
        - Write tests for condition classes
        - Write tests for persistence layer
      </tasks>
    </step>

    <step number="13">
      <title>Browser/Integration Tests</title>
      <tasks>
        - Set up Playwright/Puppeteer
        - Write admin interface tests
        - Write frontend execution tests
        - Test debug logging
        - Test persistence behavior
      </tasks>
    </step>

    <step number="14">
      <title>Polish and Documentation</title>
      <tasks>
        - Add inline code documentation
        - Ensure proper Drupal coding standards
        - Add README.md with usage instructions
        - Test on both Drupal 10 and Drupal 11
        - Final validation of all features
      </tasks>
    </step>
  </implementation_steps>

  <success_criteria>
    <functionality>
      - Settings form saves debug mode, persistence, and config export settings
      - Feature flags can be created with minimum 2 variants
      - Variants use CodeMirror JSON editor with syntax highlighting and validation
      - Algorithms can be added, configured, and reordered via drag-and-drop
      - Conditions can be added to algorithms with AND/OR/NOT operators
      - Form validates catch-all algorithm requirement
      - Form validates percentage rollout sums to 100%
      - Feature flag config entities save and load correctly
      - drupalSettings contains proper flag configuration on frontend
      - JavaScript resolves flags correctly based on algorithms and conditions
      - Persistence stores and retrieves decisions from localStorage
      - Debug mode logs all decision steps to console
      - Config export exclusion works when enabled
    </functionality>

    <code_quality>
      - PHP code uses PHP 8.2 features appropriately
      - JavaScript uses ES6 class syntax
      - All code follows Drupal coding standards
      - Plugin architecture follows ab_tests module patterns
      - Forms use proper Drupal Form API patterns
      - AJAX callbacks work reliably
      - No JavaScript build step required
    </code_quality>

    <testing>
      - All PHPUnit tests pass
      - All Jest tests pass
      - Browser tests verify end-to-end functionality
      - Tests cover edge cases (deleted variants, missing context, etc.)
    </testing>

    <compatibility>
      - Module installs on Drupal 10.3, 10.4, 11.0, 11.1
      - No deprecation warnings
      - Works with standard Drupal caching
      - CodeMirror loads correctly from CDN
    </compatibility>
  </success_criteria>
</project_specification>
