<!DOCTYPE html>
<html>
<head>
    <title>Feature Flags - User Tier Condition Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        h1 { color: #0678BE; }
        .test-section { margin: 20px 0; padding: 15px; border-left: 4px solid #0678BE; background: #f5f5f5; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        .info { color: #666; }
    </style>
</head>
<body>
    <h1>Feature Flags - User Tier Condition Test</h1>
    <div id="results"></div>

    <!-- Mock Drupal settings -->
    <script>
        window.drupalSettings = {
            featureFlags: {
                settings: {
                    debug: true,
                    persist: false
                },
                flags: {},
                libraries: {}
            }
        };
    </script>

    <!-- Load the JavaScript files -->
    <script src="js/base/BaseCondition.js"></script>
    <script src="js/base/BaseAlgorithm.js"></script>
    <script src="js/base/FeatureFlagResult.js"></script>
    <script src="js/base/FeatureFlagConfig.js"></script>
    <script src="js/base/FeatureFlagManager.js"></script>
    <script src="js/condition/UserTier.js"></script>
    <script src="js/algorithm/PercentageRollout.js"></script>

    <script>
        const results = document.getElementById('results');

        function log(message, cssClass = '') {
            const div = document.createElement('div');
            div.innerHTML = message;
            if (cssClass) {
                div.className = cssClass;
            }
            results.appendChild(div);
            console.log(message);
        }

        // Test configuration: User Tier condition for 'premium' and 'enterprise'
        drupalSettings.featureFlags.flags.user_tier_test = {
            id: 'user_tier_test',
            label: 'User Tier Test',
            enabled: true,
            variants: [
                {
                    uuid: 'variant-premium',
                    label: 'Premium Features',
                    value: { features: ['advanced_search', 'analytics', 'api_access'] }
                },
                {
                    uuid: 'variant-basic',
                    label: 'Basic Features',
                    value: { features: ['basic_search'] }
                }
            ],
            algorithms: [
                {
                    uuid: 'algo-premium-tier',
                    pluginId: 'percentage_rollout',
                    jsClass: 'PercentageRollout',
                    configuration: {
                        percentages: {
                            'variant-premium': 100,
                            'variant-basic': 0
                        }
                    },
                    conditions: [
                        {
                            uuid: 'tier-condition-001',
                            pluginId: 'user_tier',
                            jsClass: 'UserTierCondition',
                            operator: 'OR',
                            configuration: {
                                values: ['premium', 'enterprise']
                            }
                        }
                    ],
                    weight: 0
                },
                {
                    uuid: 'algo-catch-all',
                    pluginId: 'percentage_rollout',
                    jsClass: 'PercentageRollout',
                    configuration: {
                        percentages: {
                            'variant-premium': 0,
                            'variant-basic': 100
                        }
                    },
                    conditions: [],
                    weight: 1
                }
            ]
        };

        // Run tests asynchronously
        async function runTests() {
            try {
                const manager = new FeatureFlagManager();

                log('<div class="test-section">', '');
                log('<h2>Test #63: User Tier condition matches when user_tier is in configured list</h2>');
                log('<p class="info">Configuration: User Tier condition for ["premium", "enterprise"]</p>');
                log('</div>');

                log('<div class="test-section">', '');
                log('<h2>Test 1: user_tier = "premium" (in configured list)</h2>');
                log('<p class="info">Expected: Condition should match, use premium algorithm</p>');

                manager.initialContext = { user_tier: 'premium' };
                const result1 = await manager.resolve('user_tier_test');

                log(`<p>Variant UUID: <strong>${result1.variant.uuid}</strong></p>`);
                log(`<p>Variant Label: <strong>${result1.variant.label}</strong></p>`);
                log(`<p>Features: ${JSON.stringify(result1.result.features)}</p>`);

                if (result1.variant.uuid === 'variant-premium') {
                    log('<p class="pass">✅ PASS: Correctly matched "premium" tier and used premium algorithm</p>');
                } else {
                    log('<p class="fail">❌ FAIL: Should have matched premium tier</p>');
                }
                log('</div>');

                log('<div class="test-section">', '');
                log('<h2>Test 2: user_tier = "enterprise" (in configured list)</h2>');
                log('<p class="info">Expected: Condition should match, use premium algorithm</p>');

                manager.initialContext = { user_tier: 'enterprise' };
                const result2 = await manager.resolve('user_tier_test');

                log(`<p>Variant UUID: <strong>${result2.variant.uuid}</strong></p>`);
                log(`<p>Variant Label: <strong>${result2.variant.label}</strong></p>`);
                log(`<p>Features: ${JSON.stringify(result2.result.features)}</p>`);

                if (result2.variant.uuid === 'variant-premium') {
                    log('<p class="pass">✅ PASS: Correctly matched "enterprise" tier and used premium algorithm</p>');
                } else {
                    log('<p class="fail">❌ FAIL: Should have matched enterprise tier</p>');
                }
                log('</div>');

                log('<div class="test-section">', '');
                log('<h2>Test 3: user_tier = "free" (NOT in configured list)</h2>');
                log('<p class="info">Expected: Condition should NOT match, fall through to catch-all</p>');

                manager.initialContext = { user_tier: 'free' };
                const result3 = await manager.resolve('user_tier_test');

                log(`<p>Variant UUID: <strong>${result3.variant.uuid}</strong></p>`);
                log(`<p>Variant Label: <strong>${result3.variant.label}</strong></p>`);
                log(`<p>Features: ${JSON.stringify(result3.result.features)}</p>`);

                if (result3.variant.uuid === 'variant-basic') {
                    log('<p class="pass">✅ PASS: Correctly did NOT match "free" tier, used catch-all</p>');
                } else {
                    log('<p class="fail">❌ FAIL: Should have used catch-all for free tier</p>');
                }
                log('</div>');

                log('<div class="test-section">', '');
                log('<h2>Test 4: Missing user_tier in context</h2>');
                log('<p class="info">Expected: Condition should NOT match, fall through to catch-all</p>');

                manager.initialContext = {};
                const result4 = await manager.resolve('user_tier_test');

                log(`<p>Variant UUID: <strong>${result4.variant.uuid}</strong></p>`);
                log(`<p>Variant Label: <strong>${result4.variant.label}</strong></p>`);

                if (result4.variant.uuid === 'variant-basic') {
                    log('<p class="pass">✅ PASS: Correctly handled missing user_tier, used catch-all</p>');
                } else {
                    log('<p class="fail">❌ FAIL: Should have used catch-all when user_tier missing</p>');
                }
                log('</div>');

                log('<div class="test-section">', '');
                log('<h2>Summary</h2>');
                log('<p class="pass">✅ User Tier condition correctly matches configured values</p>');
                log('<p class="info">Matching works for all values in the configured list</p>');
                log('<p class="info">Non-matching values correctly fall through to catch-all</p>');
                log('<p class="info">Missing context values are handled gracefully</p>');
                log('</div>');

            } catch (error) {
                log(`<p class="fail">ERROR: ${error.message}</p>`);
                console.error(error);
            }
        }

        // Run the tests when page loads
        runTests();
    </script>
</body>
</html>
