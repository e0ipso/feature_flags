<!DOCTYPE html>
<html>
<head>
    <title>Feature Flags - User ID Condition Test</title>
</head>
<body>
    <h1>Feature Flags - User ID Condition Test</h1>
    <div id="results"></div>

    <!-- Mock Drupal settings -->
    <script>
        window.drupalSettings = {
            featureFlags: {
                settings: {
                    debug: true,
                    persist: false
                },
                flags: {},
                libraries: {}
            }
        };
    </script>

    <!-- Load the JavaScript files -->
    <script src="js/base/BaseCondition.js"></script>
    <script src="js/base/BaseAlgorithm.js"></script>
    <script src="js/base/FeatureFlagResult.js"></script>
    <script src="js/base/FeatureFlagConfig.js"></script>
    <script src="js/base/FeatureFlagManager.js"></script>
    <script src="js/condition/UserId.js"></script>
    <script src="js/algorithm/PercentageRollout.js"></script>

    <script>
        const results = document.getElementById('results');

        function log(message) {
            const p = document.createElement('p');
            p.textContent = message;
            results.appendChild(p);
            console.log(message);
        }

        // Test configuration from conditions_test_flag
        drupalSettings.featureFlags.flags.conditions_test_flag = {
            id: 'conditions_test_flag',
            label: 'Conditions Test Flag',
            enabled: true,
            variants: [
                {
                    uuid: 'cc9a264f-a4a9-4f6d-8b08-46fe1b86fc22',
                    label: 'Standard',
                    value: {}
                },
                {
                    uuid: 'f3de5438-b548-4825-9c18-13cdfc32d4f8',
                    label: 'Premium',
                    value: {}
                }
            ],
            algorithms: [
                {
                    uuid: 'test-algo-with-condition-001',
                    pluginId: 'percentage_rollout',
                    jsClass: 'PercentageRollout',
                    configuration: {
                        percentages: {
                            'cc9a264f-a4a9-4f6d-8b08-46fe1b86fc22': 50,
                            'f3de5438-b548-4825-9c18-13cdfc32d4f8': 50
                        }
                    },
                    conditions: [
                        {
                            uuid: 'test-condition-001',
                            pluginId: 'user_id',
                            jsClass: 'UserIdCondition',
                            operator: 'OR',
                            configuration: {
                                values: ['1', '5', '10']
                            }
                        }
                    ],
                    weight: 0
                },
                {
                    uuid: 'test-algo-catch-all',
                    pluginId: 'percentage_rollout',
                    jsClass: 'PercentageRollout',
                    configuration: {
                        percentages: {
                            'cc9a264f-a4a9-4f6d-8b08-46fe1b86fc22': 100,
                            'f3de5438-b548-4825-9c18-13cdfc32d4f8': 0
                        }
                    },
                    conditions: [],
                    weight: 1
                }
            ]
        };

        // Run tests asynchronously
        async function runTests() {
            try {
                // Initialize the feature flag manager with context
                const manager = new FeatureFlagManager();

                log('=== Test 1: User ID in configured list (user_id = 5) ===');
                manager.initialContext = { user_id: '5' };
                const result1 = await manager.resolve('conditions_test_flag');
                log(`Variant UUID: ${result1.variant.uuid}`);
                log(`Variant Label: ${result1.variant.label}`);
                log(`Algorithm was used: ${result1.variant.uuid !== null ? 'YES' : 'NO'}`);

                log('\n=== Test 2: User ID NOT in configured list (user_id = 99) ===');
                manager.initialContext = { user_id: '99' };
                const result2 = await manager.resolve('conditions_test_flag');
                log(`Variant UUID: ${result2.variant.uuid}`);
                log(`Variant Label: ${result2.variant.label}`);
                log(`Test: Algorithm should fall through when condition not met`);

                log('\n=== Test 3: User ID = 1 (in list) ===');
                manager.initialContext = { user_id: '1' };
                const result3 = await manager.resolve('conditions_test_flag');
                log(`Variant UUID: ${result3.variant.uuid}`);
                log(`Algorithm was used: YES`);

                log('\n=== Test 4: User ID = 10 (in list) ===');
                manager.initialContext = { user_id: '10' };
                const result4 = await manager.resolve('conditions_test_flag');
                log(`Variant UUID: ${result4.variant.uuid}`);
                log(`Algorithm was used: YES`);
            } catch (error) {
                log(`ERROR: ${error.message}`);
                console.error(error);
            }
        }

        // Run the tests
        runTests();
    </script>
</body>
</html>
