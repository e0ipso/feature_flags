<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature Flags - Persistence Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #0678be;
      border-bottom: 3px solid #0678be;
      padding-bottom: 10px;
    }
    h2 {
      color: #333;
      border-left: 4px solid #0678be;
      padding-left: 12px;
      margin-top: 30px;
    }
    .test-info {
      background: #e7f5fd;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
    .test-case {
      border: 1px solid #ddd;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .pass {
      background: #d4edda;
      border: 1px solid #c3e6cb;
    }
    .fail {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
    }
    .expected {
      font-style: italic;
      color: #666;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <h1>Feature Flags - Persistence Test</h1>

  <div class="test-info">
    <h3>Test #68: Persistence stores decision in localStorage when enabled</h3>
    <p>This test verifies that when persistence is enabled in settings, feature flag decisions are stored in localStorage and retrieved on subsequent resolutions.</p>
    <ul>
      <li><strong>Feature flag:</strong> "test_persistence" with 2 variants</li>
      <li><strong>Algorithm:</strong> Percentage rollout (50/50 split)</li>
      <li><strong>Storage key:</strong> "feature_flags:test_persistence"</li>
      <li><strong>Expected data:</strong> { variantUuid: string, timestamp: number }</li>
    </ul>
  </div>

  <div id="test-results"></div>

  <!-- Include Feature Flags JavaScript -->
  <script>
    // Mock Drupal global
    window.Drupal = window.Drupal || { behaviors: {} };
    window.drupalSettings = window.drupalSettings || {};
  </script>

  <!-- Load Feature Flags base classes -->
  <script src="js/base/FeatureFlagConfig.js"></script>
  <script src="js/base/FeatureFlagResult.js"></script>
  <script src="js/base/BaseAlgorithm.js"></script>
  <script src="js/base/BaseCondition.js"></script>
  <script src="js/base/FeatureFlagManager.js"></script>

  <!-- Load algorithm implementation -->
  <script src="js/algorithm/PercentageRollout.js"></script>

  <script>
    // Define feature flag configuration
    const variantA = 'variant-a-uuid-123';
    const variantB = 'variant-b-uuid-456';

    window.drupalSettings.featureFlags = {
      settings: {
        debug: false,
        persist: true  // PERSISTENCE ENABLED
      },
      flags: {
        test_persistence: {
          id: 'test_persistence',
          label: 'Test Persistence',
          variants: [
            {
              uuid: variantA,
              label: 'Variant A',
              value: JSON.stringify({ enabled: true, color: 'blue' })
            },
            {
              uuid: variantB,
              label: 'Variant B',
              value: JSON.stringify({ enabled: false, color: 'red' })
            }
          ],
          algorithms: [
            {
              uuid: 'algo-1',
              pluginId: 'percentage_rollout',
              jsClass: 'PercentageRollout',
              weight: 0,
              configuration: {
                percentages: {
                  [variantA]: 50,
                  [variantB]: 50
                }
              },
              conditions: []
            }
          ]
        }
      }
    };

    // Test execution
    async function runTests() {
      const resultsDiv = document.getElementById('test-results');
      let html = '';

      // Test 1: Clear localStorage and make first decision
      html += '<div class="test-case">';
      html += '<h2>Test 1: First resolution stores decision in localStorage</h2>';
      html += '<p class="expected">Expected: After resolving flag, localStorage should contain cached decision</p>';

      try {
        // Clear localStorage
        localStorage.removeItem('feature_flags:test_persistence');

        // Verify it's cleared
        const beforeResolve = localStorage.getItem('feature_flags:test_persistence');
        html += '<div class="result pass">';
        html += `LocalStorage before resolve: ${beforeResolve === null ? 'null (cleared)' : beforeResolve}\n`;
        html += 'Result: PASS - localStorage cleared';
        html += '</div>';

        // Create manager and resolve
        const manager = new FeatureFlagManager({ user_id: 'test-user-123' });
        const result = await manager.resolve('test_persistence');

        // Check localStorage
        const afterResolve = localStorage.getItem('feature_flags:test_persistence');
        html += '<div class="result ' + (afterResolve ? 'pass' : 'fail') + '">';
        html += `LocalStorage after resolve: ${afterResolve}\n`;

        if (afterResolve) {
          const parsed = JSON.parse(afterResolve);
          html += `\nParsed data:\n`;
          html += `  variantUuid: ${parsed.variantUuid}\n`;
          html += `  timestamp: ${parsed.timestamp}\n`;
          html += `  timestamp type: ${typeof parsed.timestamp}\n`;

          // Verify structure
          const hasUuid = parsed.variantUuid && typeof parsed.variantUuid === 'string';
          const hasTimestamp = parsed.timestamp && typeof parsed.timestamp === 'number';
          const validUuid = parsed.variantUuid === variantA || parsed.variantUuid === variantB;

          html += `\nValidation:\n`;
          html += `  Has variantUuid: ${hasUuid ? 'YES' : 'NO'}\n`;
          html += `  Has timestamp: ${hasTimestamp ? 'YES' : 'NO'}\n`;
          html += `  Valid UUID: ${validUuid ? 'YES' : 'NO'}\n`;

          if (hasUuid && hasTimestamp && validUuid) {
            html += '\nResult: PASS - Decision stored correctly';
          } else {
            html += '\nResult: FAIL - Invalid structure';
          }
        } else {
          html += 'Result: FAIL - No data stored';
        }
        html += '</div>';

        // Store the variant for next test
        window.firstVariant = result.variant.uuid;
        window.firstDecision = afterResolve;

      } catch (error) {
        html += '<div class="result fail">';
        html += `Error: ${error.message}\n`;
        html += `Stack: ${error.stack}`;
        html += '</div>';
      }

      html += '</div>';

      // Test 2: Resolve again and verify same variant is returned
      html += '<div class="test-case">';
      html += '<h2>Test 2: Subsequent resolution uses cached decision</h2>';
      html += '<p class="expected">Expected: Resolving the same flag again returns the same variant from cache</p>';

      try {
        // Create new manager instance and resolve again
        const manager2 = new FeatureFlagManager({ user_id: 'test-user-123' });
        const result2 = await manager2.resolve('test_persistence');

        html += '<div class="result ' + (result2.variant.uuid === window.firstVariant ? 'pass' : 'fail') + '">';
        html += `First resolution variant: ${window.firstVariant}\n`;
        html += `Second resolution variant: ${result2.variant.uuid}\n`;
        html += `Variants match: ${result2.variant.uuid === window.firstVariant ? 'YES' : 'NO'}\n`;
        html += `\nResult: ${result2.variant.uuid === window.firstVariant ? 'PASS' : 'FAIL'} - Cached decision ${result2.variant.uuid === window.firstVariant ? 'used correctly' : 'NOT used'}`;
        html += '</div>';

      } catch (error) {
        html += '<div class="result fail">';
        html += `Error: ${error.message}\n`;
        html += `Stack: ${error.stack}`;
        html += '</div>';
      }

      html += '</div>';

      // Test 3: Clear cache and verify new decision
      html += '<div class="test-case">';
      html += '<h2>Test 3: Clearing cache allows new decision</h2>';
      html += '<p class="expected">Expected: After clearing localStorage, a new decision can be made</p>';

      try {
        // Clear localStorage
        localStorage.removeItem('feature_flags:test_persistence');

        const afterClear = localStorage.getItem('feature_flags:test_persistence');
        html += '<div class="result pass">';
        html += `LocalStorage after clear: ${afterClear === null ? 'null (cleared)' : afterClear}\n`;
        html += 'Result: PASS - localStorage cleared successfully';
        html += '</div>';

        // Resolve again with different user_id to potentially get different variant
        const manager3 = new FeatureFlagManager({ user_id: 'test-user-999' });
        const result3 = await manager3.resolve('test_persistence');

        // Check that decision was stored again
        const newCache = localStorage.getItem('feature_flags:test_persistence');
        html += '<div class="result ' + (newCache ? 'pass' : 'fail') + '">';
        html += `New decision stored: ${newCache ? 'YES' : 'NO'}\n`;
        html += `New variant: ${result3.variant.uuid}\n`;
        html += `\nResult: ${newCache ? 'PASS' : 'FAIL'} - New decision ${newCache ? 'stored correctly' : 'NOT stored'}`;
        html += '</div>';

      } catch (error) {
        html += '<div class="result fail">';
        html += `Error: ${error.message}\n`;
        html += `Stack: ${error.stack}`;
        html += '</div>';
      }

      html += '</div>';

      // Test 4: Verify storage key format
      html += '<div class="test-case">';
      html += '<h2>Test 4: Storage key follows correct format</h2>';
      html += '<p class="expected">Expected: Key format is "feature_flags:{flag_id}"</p>';

      try {
        // Check all feature flag keys in localStorage
        const keys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('feature_flags:')) {
            keys.push(key);
          }
        }

        const expectedKey = 'feature_flags:test_persistence';
        const keyExists = keys.includes(expectedKey);

        html += '<div class="result ' + (keyExists ? 'pass' : 'fail') + '">';
        html += `Expected key: ${expectedKey}\n`;
        html += `Found keys: ${keys.length > 0 ? keys.join(', ') : 'none'}\n`;
        html += `Correct key exists: ${keyExists ? 'YES' : 'NO'}\n`;
        html += `\nResult: ${keyExists ? 'PASS' : 'FAIL'} - Storage key format ${keyExists ? 'correct' : 'incorrect'}`;
        html += '</div>';

      } catch (error) {
        html += '<div class="result fail">';
        html += `Error: ${error.message}\n`;
        html += `Stack: ${error.stack}`;
        html += '</div>';
      }

      html += '</div>';

      // Test 5: Verify persistence setting is respected
      html += '<div class="test-case">';
      html += '<h2>Test 5: Persistence setting controls caching behavior</h2>';
      html += '<p class="expected">Expected: Settings object has persist: true</p>';

      try {
        const settings = drupalSettings.featureFlags.settings;
        const persistEnabled = settings.persist === true;

        html += '<div class="result ' + (persistEnabled ? 'pass' : 'fail') + '">';
        html += `Settings object: ${JSON.stringify(settings, null, 2)}\n`;
        html += `persist value: ${settings.persist}\n`;
        html += `persist type: ${typeof settings.persist}\n`;
        html += `persist === true: ${persistEnabled ? 'YES' : 'NO'}\n`;
        html += `\nResult: ${persistEnabled ? 'PASS' : 'FAIL'} - Persistence ${persistEnabled ? 'enabled correctly' : 'not enabled'}`;
        html += '</div>';

      } catch (error) {
        html += '<div class="result fail">';
        html += `Error: ${error.message}\n`;
        html += `Stack: ${error.stack}`;
        html += '</div>';
      }

      html += '</div>';

      // Update the results
      resultsDiv.innerHTML = html;
    }

    // Run tests when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', runTests);
    } else {
      runTests();
    }
  </script>
</body>
</html>
