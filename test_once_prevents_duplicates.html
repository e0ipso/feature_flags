<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test: Drupal.once() Prevents Duplicate Context Provider Registrations</title>
  <script src="/core/assets/vendor/jquery/jquery.min.js"></script>
  <script src="/core/assets/vendor/once/once.min.js"></script>
  <script src="/core/misc/drupalSettingsLoader.js"></script>
  <script src="/core/misc/drupal.js"></script>
  <script src="/core/misc/drupal.init.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #0678be;
      padding-bottom: 10px;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .step {
      margin: 15px 0;
      padding: 15px;
      border-left: 4px solid #0678be;
      background: #f9f9f9;
    }
    .pass {
      border-left-color: #28a745;
      background: #d4edda;
    }
    .fail {
      border-left-color: #dc3545;
      background: #f8d7da;
    }
    .step h3 {
      margin-top: 0;
      color: #333;
    }
    .result {
      font-family: monospace;
      background: #f4f4f4;
      padding: 10px;
      border-radius: 3px;
      margin-top: 10px;
      white-space: pre-wrap;
    }
    button {
      background: #0678be;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #045a8d;
    }
    .summary {
      font-size: 18px;
      font-weight: bold;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
    }
    .summary.pass {
      background: #28a745;
      color: white;
    }
    .summary.fail {
      background: #dc3545;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Test: Drupal.once() Prevents Duplicate Context Provider Registrations</h1>

  <div class="test-section">
    <p><strong>Test Description:</strong> Verify that using Drupal.once() in a Drupal.behavior prevents context providers from being registered multiple times when attach() is called repeatedly (e.g., during AJAX operations).</p>

    <button onclick="runTest()">Run Test</button>

    <div id="results"></div>
  </div>

  <script>
    function runTest() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      try {
        let addCount = 0;
        let callCount = 0;

        // Step 1: Add context provider that uses Drupal.once()
        addStep('Step 1: Add context provider that uses Drupal.once()', 'running');

        const testDiv = document.createElement('div');
        testDiv.id = 'test-context-div';
        document.body.appendChild(testDiv);

        Drupal.behaviors.testOnceContext = {
          attach: function(context, settings) {
            const elements = once('test-context-once', testDiv, context);
            if (elements.length > 0) {
              addCount++;
              document.addEventListener('featureFlags:provideContext', function(event) {
                callCount++;
                event.detail.addContext('test_context', 'test_value_' + callCount);
              });
            }
          }
        };

        addStep('Step 1: Context provider created with once()', 'pass', {
          note: 'Context provider will only be registered once, even if attach() is called multiple times'
        });

        // Step 2: Trigger Drupal.behaviors attach multiple times
        addStep('Step 2: Trigger Drupal.behaviors attach multiple times', 'running');

        Drupal.behaviors.testOnceContext.attach(document);
        Drupal.behaviors.testOnceContext.attach(document);
        Drupal.behaviors.testOnceContext.attach(document);

        addStep('Step 2: Called attach() 3 times', 'pass', {
          attachCallCount: 3,
          note: 'Simulates AJAX updates triggering multiple attachBehaviors() calls'
        });

        // Step 3: Verify context provider only registers once
        addStep('Step 3: Verify context provider only registers once', 'running');

        const step3Pass = addCount === 1;
        addStep('Step 3: Context provider registration count', step3Pass ? 'pass' : 'fail', {
          expected: 1,
          actual: addCount,
          result: step3Pass ?
            'PASS: Event listener was only added once despite 3 attach() calls' :
            'FAIL: Event listener was added ' + addCount + ' times'
        });

        // Step 4: Verify no duplicate context values
        addStep('Step 4: Verify no duplicate context values', 'running');

        callCount = 0;

        // Simulate what happens during feature flag resolution
        const event = new CustomEvent('featureFlags:provideContext', {
          detail: {
            addContext: (key, value) => {
              // Context is being added
            }
          }
        });

        document.dispatchEvent(event);

        const step4Pass = callCount === 1;
        addStep('Step 4: Event dispatch verification', step4Pass ? 'pass' : 'fail', {
          expected: 1,
          actual: callCount,
          result: step4Pass ?
            'PASS: Event listener called exactly once' :
            'FAIL: Event listener called ' + callCount + ' times'
        });

        // Cleanup
        delete Drupal.behaviors.testOnceContext;
        testDiv.remove();

        // Overall result
        const allPassed = step3Pass && step4Pass;
        const summary = document.createElement('div');
        summary.className = 'summary ' + (allPassed ? 'pass' : 'fail');
        summary.innerHTML = allPassed ?
          '✓ TEST PASSED: Drupal.once() successfully prevents duplicate context provider registrations' :
          '✗ TEST FAILED: Issues detected with context provider registration';
        resultsDiv.appendChild(summary);

      } catch (error) {
        addStep('Error', 'fail', {
          error: error.message,
          stack: error.stack
        });
      }
    }

    function addStep(title, status, data = {}) {
      const resultsDiv = document.getElementById('results');
      const stepDiv = document.createElement('div');
      stepDiv.className = 'step ' + (status === 'pass' ? 'pass' : status === 'fail' ? 'fail' : '');

      let html = '<h3>' + title + '</h3>';

      if (Object.keys(data).length > 0) {
        html += '<div class="result">' + JSON.stringify(data, null, 2) + '</div>';
      }

      stepDiv.innerHTML = html;
      resultsDiv.appendChild(stepDiv);
    }

    // Auto-run test on page load
    window.addEventListener('load', () => {
      setTimeout(runTest, 500);
    });
  </script>
</body>
</html>
