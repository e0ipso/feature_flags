<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature Flags - No Persistence Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #0678be;
      border-bottom: 3px solid #0678be;
      padding-bottom: 10px;
    }
    h2 {
      color: #333;
      border-left: 4px solid #0678be;
      padding-left: 12px;
      margin-top: 30px;
    }
    .test-info {
      background: #e7f5fd;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
    .test-case {
      border: 1px solid #ddd;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .pass {
      background: #d4edda;
      border: 1px solid #c3e6cb;
    }
    .fail {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
    }
    .expected {
      font-style: italic;
      color: #666;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <h1>Feature Flags - No Persistence Test</h1>

  <div class="test-info">
    <h3>Test #69: Decisions are not persisted when persistence disabled</h3>
    <p>This test verifies that when persistence is disabled in settings, feature flag decisions are NOT stored in localStorage.</p>
    <ul>
      <li><strong>Feature flag:</strong> "test_no_persistence" with 2 variants</li>
      <li><strong>Algorithm:</strong> Percentage rollout (50/50 split)</li>
      <li><strong>Persistence setting:</strong> false (disabled)</li>
      <li><strong>Expected behavior:</strong> No localStorage entries created</li>
    </ul>
  </div>

  <div id="test-results"></div>

  <!-- Include Feature Flags JavaScript -->
  <script>
    // Mock Drupal global
    window.Drupal = window.Drupal || { behaviors: {} };
    window.drupalSettings = window.drupalSettings || {};
  </script>

  <!-- Load Feature Flags base classes -->
  <script src="js/base/FeatureFlagConfig.js"></script>
  <script src="js/base/FeatureFlagResult.js"></script>
  <script src="js/base/BaseAlgorithm.js"></script>
  <script src="js/base/BaseCondition.js"></script>
  <script src="js/base/FeatureFlagManager.js"></script>

  <!-- Load algorithm implementation -->
  <script src="js/algorithm/PercentageRollout.js"></script>

  <script>
    // Define feature flag configuration
    const variantA = 'variant-a-uuid-789';
    const variantB = 'variant-b-uuid-012';

    window.drupalSettings.featureFlags = {
      settings: {
        debug: false,
        persist: false  // PERSISTENCE DISABLED
      },
      flags: {
        test_no_persistence: {
          id: 'test_no_persistence',
          label: 'Test No Persistence',
          variants: [
            {
              uuid: variantA,
              label: 'Variant A',
              value: JSON.stringify({ enabled: true, color: 'green' })
            },
            {
              uuid: variantB,
              label: 'Variant B',
              value: JSON.stringify({ enabled: false, color: 'yellow' })
            }
          ],
          algorithms: [
            {
              uuid: 'algo-1',
              pluginId: 'percentage_rollout',
              jsClass: 'PercentageRollout',
              weight: 0,
              configuration: {
                percentages: {
                  [variantA]: 50,
                  [variantB]: 50
                }
              },
              conditions: []
            }
          ]
        }
      }
    };

    // Test execution
    async function runTests() {
      const resultsDiv = document.getElementById('test-results');
      let html = '';

      // Test 1: Verify persistence is disabled in settings
      html += '<div class="test-case">';
      html += '<h2>Test 1: Persistence setting is disabled</h2>';
      html += '<p class="expected">Expected: Settings.persist should be false</p>';

      try {
        const settings = drupalSettings.featureFlags.settings;
        const persistDisabled = settings.persist === false;

        html += '<div class="result ' + (persistDisabled ? 'pass' : 'fail') + '">';
        html += `Settings object: ${JSON.stringify(settings, null, 2)}\n`;
        html += `persist value: ${settings.persist}\n`;
        html += `persist type: ${typeof settings.persist}\n`;
        html += `persist === false: ${persistDisabled ? 'YES' : 'NO'}\n`;
        html += `\nResult: ${persistDisabled ? 'PASS' : 'FAIL'} - Persistence ${persistDisabled ? 'disabled correctly' : 'not disabled'}`;
        html += '</div>';

      } catch (error) {
        html += '<div class="result fail">';
        html += `Error: ${error.message}\n`;
        html += `Stack: ${error.stack}`;
        html += '</div>';
      }

      html += '</div>';

      // Test 2: Clear localStorage and resolve flag
      html += '<div class="test-case">';
      html += '<h2>Test 2: Resolution does not create localStorage entry</h2>';
      html += '<p class="expected">Expected: After resolving flag, localStorage should remain empty</p>';

      try {
        // Clear localStorage
        localStorage.removeItem('feature_flags:test_no_persistence');

        // Verify it's cleared
        const beforeResolve = localStorage.getItem('feature_flags:test_no_persistence');
        html += '<div class="result pass">';
        html += `LocalStorage before resolve: ${beforeResolve === null ? 'null (cleared)' : beforeResolve}\n`;
        html += 'Result: PASS - localStorage cleared';
        html += '</div>';

        // Create manager and resolve
        const manager = new FeatureFlagManager({ user_id: 'test-user-456' });
        const result = await manager.resolve('test_no_persistence');

        // Check localStorage
        const afterResolve = localStorage.getItem('feature_flags:test_no_persistence');
        html += '<div class="result ' + (afterResolve === null ? 'pass' : 'fail') + '">';
        html += `Resolved variant: ${result.variant.label} (${result.variant.uuid})\n`;
        html += `LocalStorage after resolve: ${afterResolve === null ? 'null (not stored)' : afterResolve}\n`;
        html += `\nResult: ${afterResolve === null ? 'PASS' : 'FAIL'} - Decision ${afterResolve === null ? 'NOT stored (correct)' : 'was stored (incorrect)'}`;
        html += '</div>';

        // Store the variant for next test
        window.firstVariant = result.variant.uuid;

      } catch (error) {
        html += '<div class="result fail">';
        html += `Error: ${error.message}\n`;
        html += `Stack: ${error.stack}`;
        html += '</div>';
      }

      html += '</div>';

      // Test 3: Resolve multiple times with same user_id - may get different variants
      html += '<div class="test-case">';
      html += '<h2>Test 3: Multiple resolutions can produce different results</h2>';
      html += '<p class="expected">Expected: Without persistence, same user_id may get different variants (non-deterministic without caching)</p>';

      try {
        // Resolve multiple times to see if we get different results
        const results = [];
        for (let i = 0; i < 10; i++) {
          const manager = new FeatureFlagManager({ user_id: 'test-user-consistent' });
          const result = await manager.resolve('test_no_persistence');
          results.push(result.variant.uuid);
        }

        const uniqueVariants = [...new Set(results)];
        const variantCounts = {};
        results.forEach(v => {
          variantCounts[v] = (variantCounts[v] || 0) + 1;
        });

        html += '<div class="result pass">';
        html += `10 resolutions with same user_id:\n`;
        html += `Results: ${JSON.stringify(results, null, 2)}\n`;
        html += `\nUnique variants seen: ${uniqueVariants.length}\n`;
        html += `Variant distribution:\n`;
        Object.keys(variantCounts).forEach(v => {
          html += `  ${v}: ${variantCounts[v]} times\n`;
        });

        // Note: Without persistence, PercentageRollout still uses deterministic hashing,
        // so the same user_id will get the same variant. This test verifies no caching occurs.
        html += `\nNote: PercentageRollout uses deterministic hashing, so same user_id gets same variant.\n`;
        html += `The key difference is no localStorage caching occurs.\n`;
        html += `\nResult: PASS - No persistence mechanism active`;
        html += '</div>';

      } catch (error) {
        html += '<div class="result fail">';
        html += `Error: ${error.message}\n`;
        html += `Stack: ${error.stack}`;
        html += '</div>';
      }

      html += '</div>';

      // Test 4: Verify no feature_flags keys in localStorage
      html += '<div class="test-case">';
      html += '<h2>Test 4: No feature_flags keys exist in localStorage</h2>';
      html += '<p class="expected">Expected: localStorage should not contain any "feature_flags:*" keys</p>';

      try {
        // Check all feature flag keys in localStorage
        const keys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('feature_flags:')) {
            keys.push(key);
          }
        }

        const noKeys = keys.length === 0;

        html += '<div class="result ' + (noKeys ? 'pass' : 'fail') + '">';
        html += `Feature flag keys in localStorage: ${keys.length > 0 ? keys.join(', ') : 'none'}\n`;
        html += `Key count: ${keys.length}\n`;
        html += `\nResult: ${noKeys ? 'PASS' : 'FAIL'} - ${noKeys ? 'No persistence keys found (correct)' : 'Persistence keys exist (incorrect)'}`;
        html += '</div>';

      } catch (error) {
        html += '<div class="result fail">';
        html += `Error: ${error.message}\n`;
        html += `Stack: ${error.stack}`;
        html += '</div>';
      }

      html += '</div>';

      // Test 5: Verify getCachedDecision returns null
      html += '<div class="test-case">';
      html += '<h2>Test 5: getCachedDecision returns null when persistence disabled</h2>';
      html += '<p class="expected">Expected: Manager should not find any cached decisions</p>';

      try {
        const manager = new FeatureFlagManager({ user_id: 'test-user-789' });
        const cached = manager.getCachedDecision('test_no_persistence');

        html += '<div class="result ' + (cached === null ? 'pass' : 'fail') + '">';
        html += `getCachedDecision result: ${cached === null ? 'null' : JSON.stringify(cached)}\n`;
        html += `\nResult: ${cached === null ? 'PASS' : 'FAIL'} - ${cached === null ? 'No cached decision found (correct)' : 'Cached decision exists (incorrect)'}`;
        html += '</div>';

      } catch (error) {
        html += '<div class="result fail">';
        html += `Error: ${error.message}\n`;
        html += `Stack: ${error.stack}`;
        html += '</div>';
      }

      html += '</div>';

      // Update the results
      resultsDiv.innerHTML = html;
    }

    // Run tests when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', runTests);
    } else {
      runTests();
    }
  </script>
</body>
</html>
